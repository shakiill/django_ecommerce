{% extends 'storefront/base.html' %}
{% load static %}

{% block title %}Loading... - UOMO{% endblock %}

{% block content %}
<div class="product-detail-page">
    <div class="container">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="py-3 mb-3">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
                <li class="breadcrumb-item"><a href="{% url 'shop' %}">Shop</a></li>
                <li class="breadcrumb-item active" aria-current="page" id="breadcrumbName">Loading...</li>
            </ol>
        </nav>

        <!-- Loading State -->
        <div id="pdpLoading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading product details...</p>
        </div>

        <!-- Product Main Section -->
        <div class="row g-5 d-none animate-fade-in" id="pdpContent">
            <!-- Gallery Section -->
            <div class="col-lg-6">
                <div class="product-gallery sticky-top" style="top: 100px; z-index: 1;">
                    <div class="pdp-image-main mb-4 position-relative overflow-hidden rounded-4">
                        <!-- Sale Badge -->
                        <div class="pdp-sale-badge d-none" id="pdpSaleBadge">
                            <span>Sale</span>
                        </div>
                        
                        <div class="pdp-image-wrapper">
                            <img id="mainImage" 
                                 src="{% static 'assets/images/placeholder.png' %}" 
                                 alt="Product Image" 
                                 class="pdp-main-image img-fluid w-100">
                             
                             <div class="pdp-zoom-hint">
                                <i class="fas fa-search-plus"></i> Hover to zoom
                            </div>
                        </div>
                        
                        <button class="btn-expand position-absolute bottom-0 end-0 m-3" onclick="openLightbox()">
                            <i class="fas fa-expand-alt"></i>
                        </button>
                    </div>
                    
                    <!-- Thumbnails -->
                    <div class="gallery-thumbs d-flex gap-3 overflow-auto pb-2" id="galleryThumbs">
                        <!-- Thumbnails injected by JS -->
                    </div>
                </div>
            </div>

            <!-- Product Info Section -->
            <div class="col-lg-6">
                <div class="product-info-wrapper ps-lg-4">
                    <!-- Category & Rating -->
                    <div class="pdp-meta mb-3">
                        <a href="#" class="pdp-category" id="pdpCategory">CATEGORY</a>
                        <div class="pdp-rating">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star-half-alt"></i>
                            <span class="rating-count ms-2 text-muted">(4.8 Reviews)</span>
                        </div>
                    </div>
                    
                    <h1 class="pdp-title mb-3" id="pdpName">Product Name</h1>
                    
                    <!-- Price -->
                    <div class="pdp-price-section mb-4">
                        <div class="pdp-price" id="pdpPrice">৳0.00</div>
                        <div class="pdp-old-price d-none" id="pdpOldPrice">৳0.00</div>
                        <div class="pdp-stock-status ms-auto">
                            <i class="fas fa-check-circle"></i>
                            <span>In Stock</span>
                        </div>
                    </div>

                    <div class="pdp-description text-muted mb-4" id="pdpShortDesc"></div>
                    
                    <div class="pdp-divider my-4"></div>

                    <!-- Attributes Section -->
                    <div class="product-attributes mb-4" id="pdpAttributes">
                        <!-- Attributes injected by JS -->
                    </div>

                    <!-- Actions -->
                    <div class="pdp-actions mb-5">
                        <div class="pdp-quantity">
                            <label class="pdp-label mb-2">Quantity</label>
                            <div class="quantity-selector">
                                <button type="button" class="qty-btn qty-minus" onclick="updatePdpQty(-1)">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input type="text" class="qty-input" id="pdpQty" value="1" readonly>
                                <button type="button" class="qty-btn qty-plus" onclick="updatePdpQty(1)">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="d-flex flex-column flex-sm-row gap-3 flex-grow-1 w-100 mt-4 mt-sm-0">
                            <button class="pdp-add-to-cart flex-grow-1" id="addToCartBtn" onclick="pdpAddToCart()">
                                <i class="fas fa-shopping-bag"></i>
                                <span id="btnText">Add to Cart</span>
                            </button>
                            <button class="pdp-buy-now flex-grow-1" id="buyNowBtn" onclick="pdpBuyNow()">
                                <i class="fas fa-bolt"></i>
                                <span>Buy Now</span>
                            </button>
                        </div>
                    </div>

                    <!-- Secondary Actions -->
                    <div class="pdp-secondary-actions d-flex gap-4 mb-4">
                        <button class="pdp-action-btn">
                            <i class="far fa-heart"></i> Add to Wishlist
                        </button>
                        <button class="pdp-action-btn">
                            <i class="fas fa-share-alt"></i> Share
                        </button>
                    </div>

                    <!-- Meta Info -->
                    <div class="pdp-product-meta p-4 bg-light rounded-3">
                        <div class="mb-2 d-flex justify-content-between">
                            <span class="text-muted fw-bold">SKU:</span>
                            <span class="text-dark" id="pdpSku">N/A</span>
                        </div>
                        <div class="mb-2 d-flex justify-content-between">
                            <span class="text-muted fw-bold">Category:</span>
                            <span class="text-dark" id="pdpMetaCategory"></span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted fw-bold">Tags:</span>
                            <span class="text-dark">Modern, Luxury, Trend</span>
                        </div>
                    </div>
                    
                    <!-- Trust Badges -->
                    <div class="pdp-trust-badges mt-4">
                        <div class="trust-badge">
                            <i class="fas fa-truck"></i>
                            <span>Free Delivery</span>
                        </div>
                        <div class="trust-badge">
                            <i class="fas fa-undo"></i>
                            <span>Easy Returns</span>
                        </div>
                        <div class="trust-badge">
                            <i class="fas fa-shield-alt"></i>
                            <span>Secure Payment</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs Section -->
        <div class="row mt-5 pt-5 d-none animate-up" id="pdpTabsSection">
            <div class="col-12">
                <ul class="nav nav-tabs pdp-tabs justify-content-center mb-5" id="productTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="desc-tab" data-bs-toggle="tab" data-bs-target="#desc" type="button" role="tab">Description</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab">Reviews (0)</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">Additional Info</button>
                    </li>
                </ul>
                <div class="tab-content" id="productTabsContent">
                    <!-- Description Tab -->
                    <div class="tab-pane fade show active" id="desc" role="tabpanel">
                        <div class="row justify-content-center">
                            <div class="col-lg-8">
                                <div class="prose text-muted lh-lg" id="pdpFullDesc"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reviews Tab -->
                    <div class="tab-pane fade" id="reviews" role="tabpanel">
                        <div class="text-center py-5 text-muted">
                            <div class="mb-4">
                                <i class="far fa-comment-alt fa-3x text-light-gray"></i>
                            </div>
                            <h5>No reviews yet</h5>
                            <p class="mb-4">Be the first to review this product!</p>
                            <button class="btn btn-outline-dark rounded-pill px-4">Write a Review</button>
                        </div>
                    </div>
                    
                    <!-- Additional Info Tab -->
                    <div class="tab-pane fade" id="info" role="tabpanel">
                        <div class="row justify-content-center">
                            <div class="col-lg-8">
                                <table class="table table-bordered">
                                    <tbody>
                                        <tr>
                                            <th class="bg-light w-25">Weight</th>
                                            <td>0.5 kg</td>
                                        </tr>
                                        <tr>
                                            <th class="bg-light">Dimensions</th>
                                            <td>20 x 10 x 5 cm</td>
                                        </tr>
                                        <tr>
                                            <th class="bg-light">Materials</th>
                                            <td>100% Cotton</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* ============================================
       PRODUCT DETAIL PAGE - Premium Design
       ============================================ */
    
    :root {
        --pdp-primary: #111111;
        --pdp-accent: #ff4e50;
        --pdp-bg-light: #f8f9fa;
        --pdp-border-color: #e5e7eb;
    }

    .product-detail-page {
        padding-top: 30px;
        padding-bottom: 80px;
        background: #fff;
        font-family: 'Jost', sans-serif;
    }

    /* Gallery */
    .pdp-image-main {
        background: var(--pdp-bg-light);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
        cursor: crosshair;
    }
    
    .pdp-image-wrapper {
        position: relative;
        overflow: hidden;
        border-radius: 12px;
        transition: transform 0.3s ease;
    }

    .pdp-main-image {
        max-height: 600px;
        object-fit: contain;
        transition: transform 0.5s ease;
        will-change: transform;
    }
    
    .pdp-image-main:hover .pdp-main-image {
        transform: scale(1.05);
    }
    
    .pdp-zoom-hint {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.7);
        color: #fff;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
    }
    
    .pdp-image-main:hover .pdp-zoom-hint {
        opacity: 1;
    }
    
    /* Sale Badge */
    .pdp-sale-badge {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 10;
    }
    
    .pdp-sale-badge span {
        background: linear-gradient(135deg, #ff4e50 0%, #f9d423 100%);
        color: #fff;
        padding: 6px 16px;
        border-radius: 30px;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 4px 10px rgba(255, 78, 80, 0.3);
    }
    
    .btn-expand {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #fff;
        border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        color: #333;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
    }
    
    .pdp-image-main:hover .btn-expand {
        opacity: 1;
    }
    
    .btn-expand:hover {
        background: var(--pdp-primary);
        color: #fff;
    }

    /* Thumbnails */
    .gallery-thumbs .thumb-item {
        width: 80px;
        height: 80px;
        border-radius: 10px;
        border: 2px solid transparent;
        overflow: hidden;
        cursor: pointer;
        opacity: 0.6;
        background: var(--pdp-bg-light);
        transition: all 0.3s;
        flex-shrink: 0;
        padding: 5px;
    }
    
    .gallery-thumbs .thumb-item img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
    
    .gallery-thumbs .thumb-item.active-thumb,
    .gallery-thumbs .thumb-item:hover {
        border-color: var(--pdp-primary);
        opacity: 1;
        transform: translateY(-2px);
    }

    /* Info Section */
    .pdp-category {
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 2px;
        color: var(--pdp-accent);
        background: rgba(255, 78, 80, 0.1);
        padding: 5px 12px;
        border-radius: 20px;
        text-decoration: none;
        transition: all 0.2s;
        display: inline-block;
        margin-right: 15px;
    }
    
    .pdp-category:hover {
        background: var(--pdp-accent);
        color: #fff;
    }

    .pdp-rating {
        display: inline-flex;
        align-items: center;
        color: #fbbf24;
        font-size: 13px;
    }
    
    .pdp-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: #111;
        line-height: 1.2;
    }
    
    .pdp-price-section {
        display: flex;
        align-items: baseline;
        gap: 15px;
    }
    
    .pdp-price {
        font-size: 2rem;
        font-weight: 700;
        color: #111;
    }
    
    .pdp-old-price {
        font-size: 1.25rem;
        color: #9ca3af;
        text-decoration: line-through;
        font-weight: 500;
    }
    
    .pdp-stock-status {
        color: #10b981;
        font-size: 14px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .pdp-description {
        line-height: 1.7;
        font-size: 1rem;
    }
    
    .pdp-divider {
        height: 1px;
        background: linear-gradient(90deg, transparent, #e5e7eb, transparent);
    }

    /* Attributes */
    .pdp-label {
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #4b5563;
        display: block;
    }
    
    .pdp-attr-btn {
        padding: 10px 20px;
        border: 1px solid var(--pdp-border-color);
        background: #fff;
        color: #374151;
        font-weight: 600;
        font-size: 14px;
        border-radius: 8px;
        transition: all 0.2s;
        min-width: 48px;
    }
    
    .pdp-attr-btn:hover {
        border-color: #111;
        background: #f9fafb;
    }
    
    .pdp-attr-btn.active {
        background: #111;
        color: #fff;
        border-color: #111;
    }
    
    /* Actions */
    .quantity-selector {
        display: inline-flex;
        align-items: center;
        background: #f3f4f6;
        border-radius: 8px;
        height: 48px;
    }
    
    .qty-btn {
        width: 40px;
        height: 100%;
        border: none;
        background: transparent;
        color: #374151;
        cursor: pointer;
        transition: color 0.2s;
    }
    
    .qty-btn:hover { color: #111; }
    
    .qty-input {
        width: 50px;
        height: 100%;
        border: none;
        background: transparent;
        text-align: center;
        font-weight: 700;
        color: #111;
    }
    
    .pdp-actions {
        display: flex;
        flex-wrap: wrap;
        align-items: flex-end;
        gap: 20px;
    }
    
    .pdp-add-to-cart {
        height: 54px;
        background: linear-gradient(135deg, #111 0%, #333 100%);
        color: #fff;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        transition: all 0.3s;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        font-size: 14px;
    }
    
    .pdp-add-to-cart:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        background: linear-gradient(135deg, #000 0%, #222 100%);
    }
    
    .pdp-buy-now {
        height: 54px;
        background: transparent;
        color: #111;
        border: 2px solid #111;
        border-radius: 8px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        transition: all 0.3s;
        font-size: 14px;
    }
    
    .pdp-buy-now:hover {
        background: #111;
        color: #fff;
    }
    
    .pdp-action-btn {
        background: none;
        border: none;
        color: #6b7280;
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 0;
        transition: color 0.2s;
    }
    
    .pdp-action-btn:hover { color: var(--pdp-accent); }
    
    .pdp-trust-badges {
        display: flex;
        gap: 24px;
        padding-top: 20px;
        border-top: 1px solid var(--pdp-border-color);
        flex-wrap: wrap;
    }
    
    .trust-badge {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 13px;
        color: #4b5563;
        font-weight: 500;
    }
    
    .trust-badge i {
        color: #10b981;
        font-size: 16px;
    }

    /* Tabs */
    .pdp-tabs {
        border-bottom: 2px solid #f3f4f6;
    }
    
    .pdp-tabs .nav-link {
        border: none;
        color: #9ca3af;
        font-weight: 600;
        font-size: 18px;
        padding: 15px 30px;
        background: transparent;
        position: relative;
    }
    
    .pdp-tabs .nav-link.active {
        color: #111;
    }
    
    .pdp-tabs .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 100%;
        height: 2px;
        background: #111;
    }

    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-up {
        animation: fadeInUp 0.5s ease forwards;
        opacity: 0;
    }

    /* Responsive */
    @media (max-width: 991px) {
        .pdp-title { font-size: 2rem; }
        .pdp-image-main { padding: 20px; }
        .pdp-price { font-size: 1.75rem; }
    }
</style>
<style>
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    const PDP_SLUG = "{{ product_slug }}";
    
    // State Management
    let pdpProduct = null;
    let pdpVariants = [];
    let pdpSelectedAttributes = {};
    let pdpSelectedVariant = null;

    document.addEventListener('DOMContentLoaded', () => {
        if(PDP_SLUG) {
            initPDP(PDP_SLUG);
        } else {
            showError('Product not found.', document.getElementById('pdpLoading'));
        }
    });

    async function initPDP(slug) {
        // Reset State
        pdpProduct = null;
        pdpVariants = [];
        pdpSelectedAttributes = {};
        pdpSelectedVariant = null;

        try {
            const data = await apiFetch(`/products/${slug}/`);
            pdpProduct = data;
            pdpVariants = data.variant_list || [];
            
            renderPDP();
        } catch (error) {
            console.error('Error loading PDP:', error);
            showError(`
                Failed to load product details. <br>
                <button class="btn btn-sm btn-outline-danger mt-2" onclick="location.reload()">Retry</button>
            `, document.getElementById('pdpLoading'));
        }
    }

    function renderPDP() {
        if (!pdpProduct) return;
        
        console.log("Rendering PDP with product:", pdpProduct);

        try {
            // Hide loader, show content
            document.getElementById('pdpLoading').classList.add('d-none');
            document.getElementById('pdpContent').classList.remove('d-none');
            document.getElementById('pdpTabsSection').classList.remove('d-none');
            
            // Populate Meta
            document.title = `${pdpProduct.name} - UOMO`;
            
            const breadcrumb = document.getElementById('breadcrumbName');
            if(breadcrumb) breadcrumb.textContent = pdpProduct.name;
            
            const titleEl = document.getElementById('pdpName');
            if(titleEl) titleEl.textContent = pdpProduct.name;

            const catEl = document.getElementById('pdpCategory');
            if(catEl) {
                catEl.textContent = pdpProduct.category_name || "Uncategorized";
                catEl.href = `/shop/?category=${pdpProduct.category || ''}`;
            }

            const metaCatEl = document.getElementById('pdpMetaCategory');
            if(metaCatEl) metaCatEl.textContent = pdpProduct.category_name || "Uncategorized";
            
            // Description
            const shortDesc = document.getElementById('pdpShortDesc');
            if(shortDesc) shortDesc.innerHTML = pdpProduct.short_description || "No short description available.";

            const fullDesc = document.getElementById('pdpFullDesc');
            if(fullDesc) fullDesc.innerHTML = pdpProduct.description || "<p>No detailed description available.</p>";

            // Images - Always set initial product image/thumbnail first
            let initialImages = [];
            if(pdpProduct.images && pdpProduct.images.length > 0) {
                 // Assuming product.images is list of objects with .image url
                 initialImages = pdpProduct.images.map(i => i.image);
            } else if(pdpProduct.thumbnail) {
                 initialImages = [pdpProduct.thumbnail];
            }
            // Fallback placeholder if absolutely nothing
            if(initialImages.length === 0) initialImages = ['/static/assets/images/placeholder.png'];
            
            updateImages(initialImages[0], initialImages);

            // Attributes
            const attributes = pdpProduct.attributes_list || [];
            renderAttributes(attributes);

            // Variant Selection / Price Init
            const defaultVarId = pdpProduct.default_variant;
            let initialVariant = null;

            if (defaultVarId) {
                initialVariant = pdpVariants.find(v => v.id === defaultVarId);
            }
            if (!initialVariant && pdpVariants.length > 0) {
                initialVariant = pdpVariants[0];
            }

            if (attributes.length > 0) {
                // If we have attributes, try to pre-select
                if (initialVariant) {
                    preSelectVariant(initialVariant, attributes);
                } else {
                    // No variant found matching? show base price
                    updatePrice(pdpProduct.price, null, false);
                }
            } else {
                // No attributes (Single variant or Simple product)
                if (initialVariant) {
                    // We found a variant (e.g. the single one), set it as selected
                    pdpSelectedVariant = initialVariant;
                    updatePrice(initialVariant.price, initialVariant.discount_price, initialVariant.is_discount);
                    if(initialVariant.sku) document.getElementById('pdpSku').textContent = initialVariant.sku;
                    
                    // If this single variant has images, use them, otherwise we keep base images
                    if (initialVariant.image_list && initialVariant.image_list.length > 0) {
                        updateImages(initialVariant.image_list[0], initialVariant.image_list);
                    }
                    setButtonsState(true, 'Add to Cart');
                } else {
                    // Fallback to product info
                    updatePrice(pdpProduct.price, null, false);
                    setButtonsState(true, 'Add to Cart');
                }
            }

            // Animation Entrance
            document.querySelectorAll('.product-info-wrapper > *').forEach((el, idx) => {
                el.style.opacity = '0';
                el.style.animation = `fadeInUp 0.5s ease ${idx * 0.05}s forwards`;
            });
            
        } catch (err) {
            console.error("Error in renderPDP:", err);
            // alert("Render Error: " + err.message);
        }
    }

    // ... renderAttributes ...

    // ... selectAttribute ...

    function checkVariantMatch() {
        const requiredCount = document.querySelectorAll('#pdpAttributes .mb-4').length;
        if(requiredCount > 0 && Object.keys(pdpSelectedAttributes).length < requiredCount) return;

        const match = pdpVariants.find(v => {
            const variantAttrs = v.attributes; 
            const selectedAttrs = Object.values(pdpSelectedAttributes);
            return selectedAttrs.every(id => variantAttrs.includes(id));
        });

        if (match) {
            pdpSelectedVariant = match;
            updatePrice(match.price, match.discount_price, match.is_discount);
            document.getElementById('pdpSku').textContent = match.sku || pdpProduct.sku || 'N/A';
            
            // Only update images if the variant explicitly has them
            if (match.image_list && match.image_list.length > 0) {
                updateImages(match.image_list[0], match.image_list);
            } 
            // Else: Keep showing the product level images, which is usually correct for "Color: Black -> shows main black jacket" 
            // if that main image was the product thumbnail. 
            // If the variation should change image (e.g. Color Red) but has no image in API, 
            // we can't do much but show previous image.
            
            setButtonsState(true, 'Add to Cart');
        } else {
            pdpSelectedVariant = null;
            setButtonsState(false, 'Unavailable');
        }
    }

    function updatePrice(price, discountPrice, isDiscount) {
        const priceEl = document.getElementById('pdpPrice');
        const oldPriceEl = document.getElementById('pdpOldPrice');
        const badge = document.getElementById('pdpSaleBadge');

        const p = parseFloat(price);
        const dp = discountPrice ? parseFloat(discountPrice) : null;

        if (dp && dp < p) {
            priceEl.textContent = `৳${dp.toFixed(0)}`;
            oldPriceEl.textContent = `৳${p.toFixed(0)}`;
            oldPriceEl.classList.remove('d-none');
            badge.classList.remove('d-none');
            priceEl.classList.add('text-danger');
        } else {
            priceEl.textContent = `৳${p.toFixed(0)}`;
            oldPriceEl.classList.add('d-none');
            badge.classList.add('d-none');
            priceEl.classList.remove('text-danger');
        }
    }

    function updateImages(mainSrc, imageList) {
        if(mainSrc) {
            const main = document.getElementById('mainImage');
            main.style.opacity = 0;
            setTimeout(() => {
                main.src = mainSrc;
                main.style.opacity = 1;
            }, 200);
        }

        const thumbs = document.getElementById('galleryThumbs');
        thumbs.innerHTML = '';
        
        if(!imageList || imageList.length === 0) {
            if(pdpProduct.thumbnail) imageList = [pdpProduct.thumbnail];
            else imageList = [];
        }

        imageList.forEach((src, idx) => {
            const thumb = document.createElement('div');
            thumb.className = `thumb-item ${idx === 0 ? 'active-thumb' : ''}`;
            thumb.innerHTML = `<img src="${src}">`;
            thumb.onclick = () => {
                document.querySelectorAll('.thumb-item').forEach(t => t.classList.remove('active-thumb'));
                thumb.classList.add('active-thumb');
                
                const main = document.getElementById('mainImage');
                main.style.opacity = 0;
                setTimeout(() => {
                    main.src = src;
                    main.style.opacity = 1;
                }, 200);
            };
            thumbs.appendChild(thumb);
        });
    }

    function preSelectVariant(variant, attributes) {
        if(!variant || !variant.attributes) return;

        attributes.forEach(attr => {
            const matchingValId = variant.attributes.find(id => 
                attr.values.some(v => v.id === id)
            );
            
            if(matchingValId) {
                const btn = document.querySelector(`.pdp-attr-btn[data-attr-id="${attr.id}"][data-val-id="${matchingValId}"]`);
                if(btn) selectAttribute(attr.id, matchingValId, btn);
            }
        });
    }

    function updatePdpQty(change) {
        const input = document.getElementById('pdpQty');
        let val = parseInt(input.value) + change;
        if(val < 1) val = 1;
        
        // Check stock if variant selected
        if(pdpSelectedVariant && pdpSelectedVariant.stock && val > pdpSelectedVariant.stock) {
            val = pdpSelectedVariant.stock;
        }
        input.value = val;
    }

    async function pdpAddToCart(redirect = false) {
        const qty = parseInt(document.getElementById('pdpQty').value);
        
        // Validation: Verify if attributes need strictly to be selected
        // Matches Quick View logic
        if (pdpVariants.length > 0 && !pdpSelectedVariant) {
             const attrDiv = document.getElementById('pdpAttributes');
             // If attributes are displayed but no variant resolved => incomplete selection
             if (attrDiv && attrDiv.children.length > 0) {
                 attrDiv.style.animation = 'none';
                 attrDiv.offsetHeight; // trigger reflow
                 attrDiv.style.animation = 'shake 0.5s';
                 
                 // Show toast or tooltip could be added here
                 return; 
             }
        }

        // Resolve Target Variant ID
        let variantId = pdpSelectedVariant ? pdpSelectedVariant.id : null;
        
        // Fallback Logic (Only if validation passed, meaning no attributes required or single variant handled)
        if(!variantId && pdpProduct.default_variant) {
            variantId = pdpProduct.default_variant;
        } else if(!variantId && pdpVariants.length === 1) {
            variantId = pdpVariants[0].id;
        }

        const payload = {
            product_id: pdpProduct.id,
            variant_id: variantId,
            quantity: qty
        };

        // UI Feedback
        const btn = document.getElementById('addToCartBtn');
        const buyBtn = document.getElementById('buyNowBtn');
        const btnText = document.getElementById('btnText');
        const originalText = btnText ? btnText.innerText : 'Add to Cart';

        try {
            if(!redirect) {
                if(btn) {
                    btn.disabled = true;
                    if(btnText) btnText.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
                }
            } else {
                if(buyBtn) {
                    buyBtn.disabled = true;
                    buyBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
                }
            }

            await apiFetch('/cart/', { method: 'POST', body: JSON.stringify(payload) });

            if(redirect) {
                window.location.href = '/cart/';
                return;
            }

            // Success State
            if(btnText) btnText.innerHTML = 'Added!';
            if(btn) btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)'; // Success Green
            
            if(window.updateCartCount) window.updateCartCount();

            setTimeout(() => {
                if(btn) {
                    btn.disabled = false;
                    btn.style.background = ''; // Revert to CSS default
                }
                if(btnText) btnText.innerText = originalText;
                if(buyBtn) buyBtn.disabled = false;
            }, 2000);

        } catch(error) {
            console.error(error);
            if(btn) btn.disabled = false;
            if(buyBtn) buyBtn.disabled = false;
            if(btnText) btnText.innerText = 'Error';
            if(buyBtn) buyBtn.innerHTML = '<i class="fas fa-bolt"></i> <span>Buy Now</span>';
            alert("Failed to add to cart: " + error.message);
        }
    }

    function pdpBuyNow() {
        pdpAddToCart(true);
    }

    function setButtonsState(enabled, text) {
        const btn = document.getElementById('addToCartBtn');
        const btnText = document.getElementById('btnText');
        if(btn) btn.disabled = !enabled;
        if(enabled && btnText) btnText.textContent = text;
        if(!enabled && btnText) btnText.textContent = text; 
    }
    
    // Lightbox placeholder (optional)
    function openLightbox() {
        // Implement full screen gallery if desired
    }

</script>
{% endblock %}
