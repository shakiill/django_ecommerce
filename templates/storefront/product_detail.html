{% extends 'storefront/base.html' %}
{% load static %}

{% block title %}Product Detail - Shop{% endblock %}

{% block content %}
<main class="product-detail-page pt-110">
    <div class="container-custom">
        <!-- Breadcrumbs -->
        <nav class="breadcrumb-nav mb-4" aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item"><a href="/shop/">Shop</a></li>
                <li class="breadcrumb-item active" aria-current="page" id="breadcrumb-product-name">Product</li>
            </ol>
        </nav>

        <div class="row g-5">
            <!-- Product Gallery Column -->
            <div class="col-lg-7">
                <div class="product-gallery-container sticky-top" style="top: 110px; z-index: 10;">
                    <div class="row g-3">
                        <!-- Vertical Thumbnails -->
                        <div class="col-md-2 order-2 order-md-1">
                            <div class="product-thumbnails d-flex flex-md-column gap-3" id="product-thumbnails">
                                <!-- Dynamic Thumbnails -->
                            </div>
                        </div>
                        
                        <!-- Main Image -->
                        <div class="col-md-10 order-1 order-md-2">
                            <div class="product-main-view glass-panel p-3">
                                <div class="main-image-wrapper">
                                    <img id="main-product-image" src="" alt="Product" class="img-fluid rounded-4">
                                    <div id="zoom-lens"></div>
                                    <div class="image-zoom-hint">
                                        <i class="fas fa-search-plus"></i> Hover to Zoom
                                    </div>
                                    <div id="product-badges" class="product-badges-detail">
                                        <!-- Dynamic Badges -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Info Column -->
            <div class="col-lg-5">
                <div class="product-details-content">
                    <div class="qv-meta mb-2">
                        <span class="qv-category" id="detail-category">Category</span>
                        <div class="detail-brand d-flex align-items-center gap-2">
                             <span class="text-muted small fw-bold">BRAND:</span>
                             <span id="detail-brand" class="fw-bold text-dark">Brand Name</span>
                        </div>
                    </div>

                    <h1 class="qv-title mb-3" id="detail-title">Loading...</h1>
                    
                    <div class="detail-rating-section mb-4 d-flex align-items-center gap-3">
                        <div class="qv-rating">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star-half-alt"></i>
                        </div>
                        <span class="text-muted small">(4.8 / 5.0 Rating based on 24 reviews)</span>
                    </div>

                    <div class="qv-price-section mb-4">
                        <div class="qv-price d-flex align-items-center gap-3">
                            <span id="detail-price" class="text-primary fs-2 fw-900">৳0.00</span>
                            <span id="detail-old-price" class="text-muted text-decoration-line-through fs-5" style="display: none;">৳0.00</span>
                        </div>
                        <div class="qv-stock-status mt-2">
                            <i class="fas fa-check-circle text-success"></i>
                            <span id="stock-status-text">In Stock</span>
                        </div>
                    </div>

                    <div class="qv-description mb-4" id="detail-short-description">
                        <!-- Short description or snippet -->
                    </div>

                    <div class="qv-divider mb-4"></div>

                    <!-- Attributes Container -->
                    <div id="detail-attributes-container" class="qv-attributes">
                        <!-- Dynamic attributes -->
                    </div>

                    <!-- Actions Section -->
                    <div class="qv-actions-wrapper glass-panel p-4 mb-4">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <div class="qv-quantity">
                                    <label class="qv-label mb-2 d-block">Quantity</label>
                                    <div class="quantity-selector-detail">
                                        <button type="button" class="qty-btn" onclick="updateDetailQty(-1)">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <input type="text" class="qty-input" id="detail-qty" value="1" readonly>
                                        <button type="button" class="qty-btn" onclick="updateDetailQty(1)">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="d-flex gap-2">
                                    <button class="btn qv-add-to-cart flex-grow-1" id="detail-add-to-cart" onclick="addToCartFromDetail()">
                                        <i class="fas fa-shopping-bag me-2"></i> Add to Cart
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-dark w-100 py-3 rounded-3 fw-bold text-uppercase" onclick="buyNowFromDetail()" style="letter-spacing: 1px;">
                                <i class="fas fa-bolt me-2 text-warning"></i> Buy It Now
                            </button>
                        </div>
                    </div>

                    <!-- Secondary Actions -->
                    <div class="qv-secondary-actions mb-5 pb-4 border-bottom">
                        <button class="qv-action-btn" id="detail-wishlist-btn" data-product-id="" onclick="if(detailProduct) toggleWishlist(detailProduct.id, this)">
                            <i class="far fa-heart"></i> <span>Add to Wishlist</span>
                        </button>
                        <button class="qv-action-btn">
                            <i class="fas fa-share-alt"></i> Share Product
                        </button>
                        <button class="qv-action-btn">
                            <i class="fas fa-balance-scale"></i> Compare
                        </button>
                    </div>

                    <!-- Key Features / Trust -->
                    <div class="trust-features glass-panel p-3">
                         <div class="row g-4 text-center">
                              <div class="col-4">
                                   <div class="trust-item">
                                        <i class="fas fa-truck mb-2 text-primary fs-4"></i>
                                        <p class="mb-0 x-small fw-bold">Free Delivery</p>
                                   </div>
                              </div>
                              <div class="col-4 border-start border-end">
                                   <div class="trust-item">
                                        <i class="fas fa-undo mb-2 text-primary fs-4"></i>
                                        <p class="mb-0 x-small fw-bold">30 Days Return</p>
                                   </div>
                              </div>
                              <div class="col-4">
                                   <div class="trust-item">
                                        <i class="fas fa-shield-alt mb-2 text-primary fs-4"></i>
                                        <p class="mb-0 x-small fw-bold">Secure Pay</p>
                                   </div>
                              </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Extra Tabs -->
        <div class="product-tabs-section mt-100">
             <ul class="nav nav-tabs justify-content-center border-0 gap-5 mb-5" id="productTab" role="tablist">
                 <li class="nav-item" role="presentation">
                     <button class="nav-link active tab-link" id="description-tab" data-bs-toggle="tab" data-bs-target="#description-content" type="button" role="tab">Description</button>
                 </li>
                 <li class="nav-item" role="presentation">
                     <button class="nav-link tab-link" id="spec-tab" data-bs-toggle="tab" data-bs-target="#spec-content" type="button" role="tab">Specifications</button>
                 </li>
                 <li class="nav-item" role="presentation">
                     <button class="nav-link tab-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews-content" type="button" role="tab">Reviews (2)</button>
                 </li>
             </ul>
             <div class="tab-content glass-panel p-5 rounded-5" id="productTabContent">
                 <div class="tab-pane fade show active" id="description-content" role="tabpanel">
                     <div class="rich-text-content" id="full-description">
                         <!-- Full description -->
                     </div>
                 </div>
                 <div class="tab-pane fade" id="spec-content" role="tabpanel">
                     <div class="specs-table-container">
                         <table class="table table-striped custom-table">
                             <tbody id="specs-body">
                                 <!-- Specifications -->
                             </tbody>
                         </table>
                     </div>
                 </div>
                 <div class="tab-pane fade" id="reviews-content" role="tabpanel">
                      <div class="reviews-placeholder py-5 text-center text-muted">
                           <i class="far fa-comments fs-1 mb-3"></i>
                           <p>No reviews yet for this product.</p>
                      </div>
                 </div>
             </div>
        </div>
    </div>
</main>

<!-- Sticky Mobile Buy Bar -->
<div class="mobile-buy-bar d-lg-none">
     <div class="container-fluid d-flex gap-2">
          <div class="flex-shrink-0">
               <div class="quantity-selector-detail mobile">
                    <button class="qty-btn" onclick="updateDetailQty(-1)"><i class="fas fa-minus"></i></button>
                    <input type="text" class="qty-input" value="1" disabled>
                    <button class="qty-btn" onclick="updateDetailQty(1)"><i class="fas fa-plus"></i></button>
               </div>
          </div>
          <button class="btn btn-primary flex-grow-1" onclick="addToCartFromDetail()">Add</button>
          <button class="btn btn-dark flex-grow-1" onclick="buyNowFromDetail()">Buy</button>
     </div>
</div>

<style>
/* Product Detail Specific styles */
.product-detail-page {
    padding-bottom: 80px;
}

.breadcrumb-nav .breadcrumb {
    background: transparent;
    padding: 0;
}

.breadcrumb-item a {
    color: var(--gray-600);
    font-weight: 500;
}

.breadcrumb-item.active {
    color: var(--black);
    font-weight: 700;
}

.main-image-wrapper {
    position: relative;
    overflow: hidden;
    border-radius: 20px;
    background: var(--white);
    aspect-ratio: 1/1;
    display: flex;
    align-items: center;
    justify-content: center;
}

#main-product-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
    transition: transform 0.5s ease;
}

.main-image-wrapper:hover #main-product-image {
    cursor: zoom-in;
}

#zoom-lens {
    position: absolute;
    width: 200px;
    height: 200px;
    border: 2px solid rgba(255, 255, 255, 0.5);
    border-radius: 50%;
    cursor: none;
    display: none;
    background-repeat: no-repeat;
    box-shadow: 0 0 15px rgba(0,0,0,0.2), inset 0 0 15px rgba(0,0,0,0.1);
    pointer-events: none;
    z-index: 1000;
    background-color: #fff;
}

.main-image-wrapper:hover #zoom-lens {
    display: block;
}

.thumbnail-item {
    width: 80px;
    height: 80px;
    border-radius: 12px;
    border: 2px solid transparent;
    overflow: hidden;
    cursor: pointer;
    transition: var(--transition-base);
    background: var(--white);
    flex-shrink: 0;
}

.thumbnail-item.active {
    border-color: var(--accent-color);
    box-shadow: 0 5px 15px rgba(255, 78, 80, 0.2);
}

.thumbnail-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.qv-meta {
    display: flex;
    align-items: center;
    gap: 15px;
}

.qv-category {
    background: rgba(255, 78, 80, 0.1);
    color: var(--accent-color);
    padding: 4px 12px;
    border-radius: 50px;
    font-size: 11px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.qv-title {
    font-size: 38px;
    font-weight: 800;
    color: var(--black);
    line-height: 1.2;
}

.qv-price .fw-900 {
    font-weight: 900;
}

.quantity-selector-detail {
    display: flex;
    align-items: center;
    background: #f3f4f6;
    border-radius: 10px;
    padding: 5px;
}

.quantity-selector-detail .qty-btn {
    width: 38px;
    height: 38px;
    border: none;
    background: #fff;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition-base);
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.quantity-selector-detail .qty-btn:hover {
    background: var(--accent-color);
    color: #fff;
}

.quantity-selector-detail .qty-input {
    width: 50px;
    border: none;
    background: transparent;
    text-align: center;
    font-weight: 700;
    font-size: 16px;
}

.tab-link {
    font-size: 18px;
    font-weight: 700;
    color: var(--gray-500);
    border: none !important;
    background: transparent !important;
    position: relative;
    padding: 10px 0;
}

.tab-link.active {
    color: var(--black) !important;
}

.tab-link.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: var(--accent-color);
    border-radius: 10px;
}

.image-zoom-hint {
    position: absolute;
    bottom: 20px;
    right: 20px;
    padding: 6px 12px;
    background: rgba(0,0,0,0.5);
    color: #fff;
    border-radius: 50px;
    font-size: 11px;
    backdrop-filter: blur(5px);
    pointer-events: none;
}

.product-badges-detail {
    position: absolute;
    top: 20px;
    left: 20px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.mobile-buy-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: #fff;
    padding: 15px;
    box-shadow: 0 -10px 30px rgba(0,0,0,0.1);
    z-index: 1000;
}

.x-small {
    font-size: 11px;
}

.fw-900 { font-weight: 900; }

@media (max-width: 767px) {
    .qv-title { font-size: 28px; }
    .product-thumbnails { overflow-x: auto; padding-bottom: 10px; }
}
</style>

<script>
    const productSlug = "{{ product_slug }}";
    let detailProduct = null;
    let detailVariants = [];
    let detailSelectedAttributes = {};
    let detailSelectedVariant = null;

    document.addEventListener('DOMContentLoaded', async () => {
        if (productSlug) {
            await loadProductDetail(productSlug);
        }
        initMagnifier();
    });

    function initMagnifier() {
        const wrapper = document.querySelector('.main-image-wrapper');
        const img = document.getElementById('main-product-image');
        const lens = document.getElementById('zoom-lens');
        
        if (!wrapper || !img || !lens) return;

        wrapper.addEventListener('mousemove', (e) => {
            const rect = wrapper.getBoundingClientRect();
            
            // Show lens
            lens.style.display = 'block';
            
            // Calculate mouse position relative to image
            let x = e.clientX - rect.left;
            let y = e.clientY - rect.top;
            
            // Prevent lens from going outside
            if (x > rect.width) x = rect.width;
            if (x < 0) x = 0;
            if (y > rect.height) y = rect.height;
            if (y < 0) y = 0;
            
            // Set lens position
            lens.style.left = (x - lens.offsetWidth / 2) + 'px';
            lens.style.top = (y - lens.offsetHeight / 2) + 'px';
            
            // Set zoom background
            const zoomLevel = 2.5;
            lens.style.backgroundImage = `url('${img.src}')`;
            lens.style.backgroundSize = (rect.width * zoomLevel) + "px " + (rect.height * zoomLevel) + "px";
            
            // Calculate background position
            let posX = (x * zoomLevel) - (lens.offsetWidth / 2);
            let posY = (y * zoomLevel) - (lens.offsetHeight / 2);
            
            lens.style.backgroundPosition = `-${posX}px -${posY}px`;
        });
        
        wrapper.addEventListener('mouseleave', () => {
            lens.style.display = 'none';
        });
    }

    async function loadProductDetail(slug) {
        try {
            const data = await apiFetch(`/products/${slug}/`);
            detailProduct = data;
            
            // Update UI elements
            document.title = `${data.name} - Shop`;
            const breadcrumbEl = document.getElementById('breadcrumb-product-name');
            if (breadcrumbEl) breadcrumbEl.textContent = data.name;
            
            const titleEl = document.getElementById('detail-title');
            if (titleEl) titleEl.textContent = data.name;
            
            const categoryEl = document.getElementById('detail-category');
            if (categoryEl) categoryEl.textContent = data.category_name || 'General';
            
            const brandEl = document.getElementById('detail-brand');
            if (brandEl) brandEl.textContent = data.brand_name || 'Generic';
            
            const shortDescEl = document.getElementById('detail-short-description');
            if (shortDescEl) shortDescEl.innerHTML = data.short_description || (data.description ? data.description.substring(0, 200) + '...' : 'No description available.');
            
            const fullDescEl = document.getElementById('full-description');
            if (fullDescEl) fullDescEl.innerHTML = data.description || 'No detailed description.';
            
            // Render Images and Thumbnails
            renderGallery(data);
            
            // Handle Specifications
            renderSpecs(data);

            // Handle Variants & Attributes
            detailVariants = data.variant_list || [];
            const attributes = data.attributes_list || [];
            
            if (attributes.length > 0) {
                renderDetailAttributes(attributes);
                // Auto-select priority
                const targetId = data.default_variant || (detailVariants.length > 0 ? detailVariants[0].id : null);
                if (targetId) {
                    const variantToSelect = detailVariants.find(v => v.id === targetId);
                    if (variantToSelect) {
                        preSelectDetailVariant(variantToSelect, attributes);
                    }
                }
            } else {
                 updateDetailUIPrice(data.old_price || data.price, data.old_price ? data.price : null);
            }
            
            // Check Wishlist Status
            if (isAuthenticated()) {
                 const wBtn = document.getElementById('detail-wishlist-btn');
                 if (wBtn) {
                     wBtn.setAttribute('data-product-id', data.id);
                     if (data.is_in_wishlist !== undefined) {
                         updateWishlistBtnState(data.id, data.is_in_wishlist);
                     } else {
                         // Fallback for safety
                         try {
                             const wRes = await apiFetch(`/wishlist/check/${data.id}/`);
                             updateWishlistBtnState(data.id, wRes.is_in_wishlist);
                         } catch(e) { console.warn('Wishlist check failed', e); }
                     }
                 }
            }
            
        } catch (error) {
            console.error('Error loading product detail:', error);
            document.getElementById('detail-title').textContent = 'Product Not Found';
        }
    }

    function renderGallery(data) {
        const thumbContainer = document.getElementById('product-thumbnails');
        thumbContainer.innerHTML = '';
        
        let images = [];
        // Use thumbnail as first image if exists
        if (data.thumbnail) images.push({ url: data.thumbnail });
        
        // Add images from images list (list of objects)
        if (data.images && data.images.length > 0) {
            data.images.forEach(img => images.push({ url: img.image }));
        }

        // Add images from variants if any (list of strings)
        if (data.variant_list) {
            data.variant_list.forEach(v => {
                if (v.image_list && v.image_list.length > 0) {
                    v.image_list.forEach(vurl => {
                         if (!images.find(i => i.url === vurl)) {
                             images.push({ url: vurl });
                         }
                    });
                }
            });
        }

        if (images.length === 0) {
             // Fallback
             document.getElementById('main-product-image').src = '{% static "assets/images/placeholder.jpg" %}';
             return;
        }

        images.forEach((imgObj, idx) => {
            const thumb = document.createElement('div');
            thumb.className = `thumbnail-item ${idx === 0 ? 'active' : ''}`;
            thumb.innerHTML = `<img src="${imgObj.url}" alt="Thumb">`;
            thumb.onclick = () => {
                document.querySelectorAll('.thumbnail-item').forEach(t => t.classList.remove('active'));
                thumb.classList.add('active');
                document.getElementById('main-product-image').src = imgObj.url;
            };
            thumbContainer.appendChild(thumb);
            
            if (idx === 0) {
                document.getElementById('main-product-image').src = imgObj.url;
            }
        });
    }

    function renderSpecs(data) {
        const body = document.getElementById('specs-body');
        body.innerHTML = '';
        
        const specs = [
            { label: 'Weight', value: data.weight ? `${data.weight} kg` : 'N/A' },
            { label: 'Dimensions', value: data.dimensions || 'N/A' },
            { label: 'Product Type', value: data.product_type || 'Physical' },
            { label: 'Warranty', value: data.warranty || 'No Warranty' },
            { label: 'Tax', value: data.tax_type || 'Inclusive' }
        ];

        specs.forEach(spec => {
             const row = document.createElement('tr');
             row.innerHTML = `<th width="30%">${spec.label}</th><td>${spec.value}</td>`;
             body.appendChild(row);
        });
    }

    function renderDetailAttributes(attributes) {
        const container = document.getElementById('detail-attributes-container');
        container.innerHTML = '';
        
        attributes.forEach(attr => {
            const group = document.createElement('div');
            group.className = 'mb-4';
            
            const label = document.createElement('label');
            label.className = 'qv-label mb-2';
            label.textContent = attr.name;
            group.appendChild(label);
            
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'd-flex flex-wrap gap-2';
            
            attr.values.forEach(val => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'attr-btn style-button';
                btn.dataset.attrId = attr.id;
                btn.dataset.valId = val.id;
                
                if (val.color_code) {
                    btn.className += ' color-swatch';
                    btn.style.backgroundColor = val.color_code;
                    btn.title = val.value;
                    btn.innerHTML = `<span class="visually-hidden">${val.value}</span>`;
                } else {
                    btn.textContent = val.value;
                }
                
                btn.onclick = () => selectDetailAttribute(attr.id, val.id, btn);
                optionsContainer.appendChild(btn);
            });
            
            group.appendChild(optionsContainer);
            container.appendChild(group);
        });
    }

    function selectDetailAttribute(attrId, valId, btn) {
        // Toggle active class in the same group
        const group = btn.parentElement;
        group.querySelectorAll('.attr-btn').forEach(b => b.classList.remove('active', 'btn-dark'));
        btn.classList.add('active', 'btn-dark');
        
        detailSelectedAttributes[attrId] = valId;
        findMatchingDetailVariant();
    }

    function preSelectDetailVariant(variant, attributes) {
        variant.attributes.forEach(attrValId => {
            // Find which attribute this value belongs to
            attributes.forEach(attr => {
                const hasVal = attr.values.find(v => v.id === attrValId);
                if (hasVal) {
                    detailSelectedAttributes[attr.id] = attrValId;
                    // Find the button and activate it
                    const btn = document.querySelector(`.attr-btn[data-attr-id="${attr.id}"][data-val-id="${attrValId}"]`);
                    if (btn) {
                        btn.classList.add('active', 'btn-dark');
                    }
                }
            });
        });
        findMatchingDetailVariant();
    }

    function findMatchingDetailVariant() {
        const selectedValIds = Object.values(detailSelectedAttributes);
        const attributeCount = detailProduct.attributes_list.length;
        
        if (selectedValIds.length === attributeCount) {
            const matching = detailVariants.find(v => {
                return v.attributes.length === selectedValIds.length && 
                       v.attributes.every(id => selectedValIds.includes(id));
            });
            
            if (matching) {
                detailSelectedVariant = matching;
                updateDetailUIPrice(matching.price, matching.discount_price);
                
                // Update image if variant has image
                if (matching.image_list && matching.image_list.length > 0) {
                    const imageUrl = matching.image_list[0];
                    document.getElementById('main-product-image').src = imageUrl;
                    
                    // Find and activate thumbnail if it exists
                    const thumbs = document.querySelectorAll('.thumbnail-item img');
                    thumbs.forEach(t => {
                        if (t.src === imageUrl) {
                            t.parentElement.classList.add('active');
                        } else {
                            t.parentElement.classList.remove('active');
                        }
                    });
                }
                
                document.getElementById('detail-add-to-cart').disabled = false;
                document.getElementById('detail-add-to-cart').innerHTML = '<i class="fas fa-shopping-bag me-2"></i> Add to Cart';
            } else {
                detailSelectedVariant = null;
                document.getElementById('detail-add-to-cart').disabled = true;
                document.getElementById('detail-add-to-cart').textContent = 'Unavailable';
            }
        }
    }

    function updateDetailUIPrice(price, discountPrice) {
        const priceEl = document.getElementById('detail-price');
        const oldPriceEl = document.getElementById('detail-old-price');
        const badgeContainer = document.getElementById('product-badges');
        
        if (discountPrice && parseFloat(discountPrice) < parseFloat(price)) {
            priceEl.textContent = `৳${discountPrice}`;
            oldPriceEl.textContent = `৳${price}`;
            oldPriceEl.style.display = 'inline';
            if (badgeContainer) {
                badgeContainer.innerHTML = '<span class="badge bg-danger p-2"><i class="fas fa-bolt me-1"></i> FLASH SALE</span>';
            }
        } else {
            priceEl.textContent = `৳${price}`;
            oldPriceEl.style.display = 'none';
            if (badgeContainer) {
                badgeContainer.innerHTML = '';
            }
        }
    }

    function updateDetailQty(delta) {
        const input = document.getElementById('detail-qty');
        let val = parseInt(input.value) + delta;
        if (val < 1) val = 1;
        input.value = val;
        
        // Update mobile mirror
        const mobileInput = document.querySelector('.mobile-buy-bar .qty-input');
        if (mobileInput) mobileInput.value = val;
    }

    async function addToCartFromDetail() {
        if (detailProduct.attributes_list.length > 0 && !detailSelectedVariant) {
             showToast('Please select all options', 'warning');
             return;
        }

        const qty = parseInt(document.getElementById('detail-qty').value);
        const variantId = detailSelectedVariant ? detailSelectedVariant.id : (detailProduct.variant_list[0] ? detailProduct.variant_list[0].id : null);
        
        if (!variantId) {
             showToast('Product error: No variant found', 'error');
             return;
        }

        const btn = document.getElementById('detail-add-to-cart');
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Adding...';
        btn.disabled = true;

        try {
            const success = await addToCart(variantId, qty);
            if (success) {
                btn.innerHTML = '<i class="fas fa-check me-2"></i> Added!';
                btn.classList.add('btn-success');
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                    btn.classList.remove('btn-success');
                    btn.disabled = false;
                }, 2000);
            } else {
                 btn.innerHTML = originalContent;
                 btn.disabled = false;
            }
        } catch (error) {
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }
    }

    async function buyNowFromDetail() {
         if (detailProduct.attributes_list.length > 0 && !detailSelectedVariant) {
             showToast('Please select all options', 'warning');
             return;
        }

        const qty = parseInt(document.getElementById('detail-qty').value);
        const variantId = detailSelectedVariant ? detailSelectedVariant.id : (detailProduct.variant_list[0] ? detailProduct.variant_list[0].id : null);
        
        const success = await addToCart(variantId, qty);
        if (success) {
             window.location.href = '/checkout/';
        }
    }
</script>

<style>
/* Additional helper classes */
.attr-btn.color-swatch {
    width: 35px;
    height: 35px;
    padding: 0;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 0 0 1px #ddd;
}
.attr-btn.color-swatch.active {
    box-shadow: 0 0 0 2px var(--accent-color);
}
.style-button {
    min-width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #ddd;
    background: #fff;
    border-radius: 8px;
    font-weight: 600;
}
.style-button.active {
    background: #111;
    color: #fff;
    border-color: #111;
}
</style>
{% endblock %}
