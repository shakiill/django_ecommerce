{% extends 'storefront/base.html' %}

{% block title %}Register - ShopHub{% endblock %}

{% block content %}
<div class="auth-page py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-5">
                <div class="auth-card">
                    <div class="text-center mb-4">
                        <h2>Create Account</h2>
                        <p class="text-muted">Join ShopHub today and start shopping!</p>
                    </div>
                    
                    <!-- Step 1: Registration Form -->
                    <form id="register-form" style="display: block;">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="name" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="password1" required>
                            <small class="text-muted">At least 8 characters</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Confirm Password</label>
                            <input type="password" class="form-control" id="password2" required>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="terms" required>
                            <label class="form-check-label" for="terms">
                                I agree to the <a href="#">Terms & Conditions</a>
                            </label>
                        </div>
                        
                        <div id="error-message" class="alert alert-danger d-none"></div>
                        
                        <button type="submit" class="btn btn-primary w-100 mb-3">
                            <i class="fas fa-user-plus me-2"></i>Create Account
                        </button>
                        
                        <div class="text-center">
                            <p class="text-muted">Already have an account? 
                                <a href="{% url 'staff_login' %}">Login here</a>
                            </p>
                        </div>
                    </form>
                    
                    <!-- Step 2: OTP Verification Form -->
                    <form id="otp-form" style="display: none;">
                        {% csrf_token %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            An OTP has been sent to your registered contact. Please enter it below to verify your account.
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Enter OTP</label>
                            <input type="text" class="form-control text-center" id="otp" 
                                   placeholder="Enter 4-digit OTP" maxlength="4" required>
                        </div>
                        
                        <div id="otp-error-message" class="alert alert-danger d-none"></div>
                        <div id="otp-success-message" class="alert alert-success d-none"></div>
                        
                        <button type="submit" class="btn btn-primary w-100 mb-3">
                            <i class="fas fa-check me-2"></i>Verify OTP
                        </button>
                        
                        <div class="text-center">
                            <button type="button" class="btn btn-link" id="resend-otp">
                                Resend OTP
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .auth-page {
        min-height: 60vh;
        display: flex;
        align-items: center;
    }
    
    .auth-card {
        background: white;
        padding: 3rem;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        border: 1px solid var(--border-color);
    }
    
    .auth-card h2 {
        color: var(--primary-color);
        font-weight: 700;
    }
    
    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .btn-primary {
        padding: 0.75rem;
        font-weight: 600;
    }
    
    #otp {
        font-size: 1.5rem;
        letter-spacing: 0.5rem;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let registeredUsername = '';
    
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    // Step 1: Registration
    document.getElementById('register-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('name').value;
        const username = document.getElementById('username').value;
        const email = document.getElementById('email').value;
        const password1 = document.getElementById('password1').value;
        const password2 = document.getElementById('password2').value;
        const errorDiv = document.getElementById('error-message');
        
        // Clear previous messages
        errorDiv.classList.add('d-none');
        
        // Validate passwords match
        if (password1 !== password2) {
            errorDiv.textContent = 'Passwords do not match!';
            errorDiv.classList.remove('d-none');
            return;
        }
        
        // Validate password length
        if (password1.length < 8) {
            errorDiv.textContent = 'Password must be at least 8 characters long!';
            errorDiv.classList.remove('d-none');
            return;
        }
        
        try {
            const response = await fetch('{% url "customer_register" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    name: name,
                    username: username,
                    email: email,
                    password: password1
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                // Registration successful - OTP sent
                registeredUsername = username;
                
                // Hide registration form, show OTP form
                document.getElementById('register-form').style.display = 'none';
                document.getElementById('otp-form').style.display = 'block';
            } else {
                errorDiv.textContent = data.error || 'Registration failed. Please try again.';
                errorDiv.classList.remove('d-none');
            }
        } catch (error) {
            console.error('Registration error:', error);
            errorDiv.textContent = 'An error occurred. Please try again later.';
            errorDiv.classList.remove('d-none');
        }
    });
    
    // Step 2: OTP Verification
    document.getElementById('otp-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const otp = document.getElementById('otp').value;
        const errorDiv = document.getElementById('otp-error-message');
        const successDiv = document.getElementById('otp-success-message');
        
        // Clear previous messages
        errorDiv.classList.add('d-none');
        successDiv.classList.add('d-none');
        
        if (!otp || otp.length !== 4) {
            errorDiv.textContent = 'Please enter a valid 4-digit OTP';
            errorDiv.classList.remove('d-none');
            return;
        }
        
        try {
            const response = await fetch('{% url "verify_otp" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    username: registeredUsername,
                    otp: otp
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                // Show success message
                successDiv.innerHTML = `
                    <strong>Success!</strong> Your account has been verified.<br>
                    <small>Redirecting to homepage...</small>
                `;
                successDiv.classList.remove('d-none');
                
                // Redirect to homepage/dashboard after 2 seconds
                setTimeout(() => {
                    window.location.href = data.redirect_url || '/';
                }, 2000);
            } else {
                errorDiv.textContent = data.error || 'OTP verification failed.';
                errorDiv.classList.remove('d-none');
            }
        } catch (error) {
            console.error('OTP verification error:', error);
            errorDiv.textContent = 'An error occurred. Please try again later.';
            errorDiv.classList.remove('d-none');
        }
    });
    
    // Resend OTP
    document.getElementById('resend-otp').addEventListener('click', async () => {
        alert('Please reload and try registering again if you missed the OTP.');
    });
</script>
{% endblock %}
