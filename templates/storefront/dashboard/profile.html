{% extends 'storefront/dashboard/dashboard_base.html' %}
{% load static %}

{% block title %}My Profile - UOMO{% endblock %}

{% block dash_extra_css %}
<style>
    .profile-card {
        background: #fff;
        border-radius: 24px;
        padding: 40px;
        box-shadow: var(--dash-shadow);
        border: var(--dash-border);
    }

    .form-section-title {
        font-weight: 880;
        font-size: 1.25rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 2px solid rgba(255, 78, 80, 0.1);
        display: inline-block;
        color: var(--theme-black);
    }

    /* Profile Image Header */
    .profile-image-header {
        display: flex;
        align-items: center;
        gap: 30px;
        margin-bottom: 40px;
        padding: 25px;
        background: #fcfcfc;
        border-radius: 20px;
        border: 1px dashed #e0e0e0;
    }

    .profile-image-preview-wrapper {
        position: relative;
        width: 120px;
        height: 120px;
    }

    .profile-image-preview {
        width: 100%;
        height: 100%;
        border-radius: 30px;
        object-fit: cover;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        background: #fff;
    }

    .image-upload-badge {
        position: absolute;
        bottom: -5px;
        right: -5px;
        width: 40px;
        height: 40px;
        background: var(--dash-primary);
        color: white;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: 3px solid #fff;
        transition: all 0.3s;
    }

    .image-upload-badge:hover {
        transform: scale(1.1);
        background: var(--theme-black);
    }

    .premium-label {
        font-weight: 700;
        font-size: 0.8rem;
        text-transform: uppercase;
        color: var(--gray-500);
        margin-bottom: 10px;
        display: block;
    }

    .premium-input {
        height: 60px;
        border-radius: 16px !important;
        border: 2px solid #f0f0f0 !important;
        padding: 0 25px !important;
        font-weight: 600 !important;
        transition: all 0.3s ease !important;
        background-color: #fcfcfc !important;
    }

    .premium-input:focus {
        background-color: #fff !important;
        border-color: var(--dash-primary) !important;
        box-shadow: 0 10px 25px rgba(255, 78, 80, 0.08) !important;
        transform: translateY(-2px);
    }

    .premium-input[readonly] {
        background-color: #f8f9fa !important;
        border-color: #eee !important;
        color: #999 !important;
        cursor: not-allowed;
    }

    .textarea-premium {
        height: auto !important;
        padding: 20px 25px !important;
        min-height: 120px;
    }

    .save-profile-btn {
        background: var(--theme-black);
        color: white;
        padding: 18px 45px;
        border-radius: 50px;
        font-weight: 800;
        letter-spacing: 1px;
        transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        border: none;
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }

    .save-profile-btn:hover {
        background: var(--dash-primary);
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 15px 30px rgba(255, 78, 80, 0.25);
        color: #fff;
    }

    .save-profile-btn:active {
        transform: translateY(-1px);
    }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="dashboard-header-premium mb-4 animate-fade-in">
    <h2 class="fw-900">Account Settings</h2>
    <p class="text-muted">Manage your identity and profile photo.</p>
</div>

<div class="profile-card animate-fade-in" style="animation-delay: 0.1s;">
    <form id="profile-form">
        <!-- New Profile Image Section -->
        <h4 class="form-section-title">Profile Photo</h4>
        <div class="profile-image-header animate-fade-in">
            <div class="profile-image-preview-wrapper">
                <img src="{% static 'assets/images/placeholder-avatar.png' %}" id="profile-preview" class="profile-image-preview" alt="Avatar">
                <label for="photo-input" class="image-upload-badge">
                    <i class="fas fa-camera"></i>
                </label>
                <input type="file" id="photo-input" name="photo" accept="image/*" style="display: none;">
            </div>
            <div>
                <h5 class="fw-800 mb-1">Your Avatar</h5>
                <p class="text-muted small mb-0">Click the camera icon to upload a new photo.<br>Optimal size: 400x400px (JPG, PNG)</p>
            </div>
        </div>

        <h4 class="form-section-title">Personal Details</h4>
        <div class="row">
            <div class="col-md-6 mb-4">
                <label class="premium-label">Phone Number (Username)</label>
                <input type="text" class="form-control premium-input" id="username" readonly>
            </div>
            
            <div class="col-md-6 mb-4">
                <label class="premium-label">Email Address</label>
                <input type="email" class="form-control premium-input" id="email" name="email" placeholder="yourname@example.com">
            </div>
            
            <div class="col-12 mb-4">
                <label class="premium-label">Full Name</label>
                <input type="text" class="form-control premium-input" id="name" name="name" placeholder="Enter your full name" required>
            </div>
            
            <div class="col-md-6 mb-4">
                <label class="premium-label">Occupation</label>
                <input type="text" class="form-control premium-input" id="occupation" name="occupation" placeholder="e.g. Software Engineer">
            </div>

            <div class="col-md-6 mb-4">
                <label class="premium-label">Date of Birth</label>
                <input type="date" class="form-control premium-input" id="dob" name="dob">
            </div>

            <div class="col-12 mb-4">
                <label class="premium-label">Bio (Short Description)</label>
                <textarea class="form-control premium-input textarea-premium" id="bio" name="bio" placeholder="Tell us a bit about yourself..."></textarea>
            </div>

            <div class="col-12 mb-4">
                <label class="premium-label">Permanent Address</label>
                <textarea class="form-control premium-input textarea-premium" id="address" name="address" placeholder="Enter your full address"></textarea>
            </div>
        </div>
        
        <div class="mt-4 pt-4 border-top">
            <button type="submit" class="save-profile-btn" id="save-btn">
                SAVE CHANGES
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block dash_extra_js %}
<script>
    const photoInput = document.getElementById('photo-input');
    const profilePreview = document.getElementById('profile-preview');

    // Handle Image Preview
    photoInput.addEventListener('change', function(e) {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => profilePreview.src = e.target.result;
            reader.readAsDataURL(this.files[0]);
        }
    });

    async function loadProfile() {
        try {
            const data = await apiFetch('/profile-update/');
            
            // Map data to fields
            document.getElementById('username').value = data.username || '';
            document.getElementById('email').value = data.email || '';
            document.getElementById('name').value = data.name || '';
            document.getElementById('occupation').value = data.occupation || '';
            document.getElementById('dob').value = data.dob || '';
            document.getElementById('bio').value = data.bio || '';
            document.getElementById('address').value = data.address || '';
            
            // Set profile image
            if (data.photo) {
                profilePreview.src = data.photo;
                // Also update sidebar avatar if it exists
                const sidebarAvatarImg = document.querySelector('#sidebar-avatar img');
                if (sidebarAvatarImg) sidebarAvatarImg.src = data.photo;
            }
            
            // Sync text with sidebar
            const sidebarName = document.getElementById('sidebar-name');
            const sidebarEmail = document.getElementById('sidebar-email');
            if (sidebarName) sidebarName.textContent = data.name || data.username;
            if (sidebarEmail) sidebarEmail.textContent = data.email;
            
        } catch (error) {
            console.error('Failed to load profile:', error);
            showToast('Failed to load profile data', 'danger');
        }
    }
    
    document.getElementById('profile-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('save-btn');
        const originalText = btn.textContent;
        
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> SAVING...';
        btn.disabled = true;
        
        // We use FormData for file uploads
        const formData = new FormData();
        formData.append('email', document.getElementById('email').value);
        formData.append('name', document.getElementById('name').value);
        formData.append('occupation', document.getElementById('occupation').value);
        formData.append('dob', document.getElementById('dob').value || '');
        formData.append('bio', document.getElementById('bio').value);
        formData.append('address', document.getElementById('address').value);
        
        if (photoInput.files[0]) {
            formData.append('photo', photoInput.files[0]);
        }
        
        try {
            // Manual fetch for FormData because apiFetch currently expects JSON stringify
            const response = await fetch(`${API_BASE_URL}/profile-update/`, {
                method: 'PATCH',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                },
                body: formData
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Failed to update profile');
            }
            
            showToast('Profile updated successfully!', 'success');
            loadProfile(); // Refresh
        } catch (error) {
            console.error('Failed to update profile:', error);
            showToast('Error: ' + error.message, 'danger');
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    });
    
    document.addEventListener('DOMContentLoaded', loadProfile);
</script>
{% endblock %}
