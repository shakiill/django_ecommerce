{% extends 'storefront/dashboard/dashboard_base.html' %}
{% load static %}

{% block title %}My Profile - UOMO{% endblock %}

{% block dash_extra_css %}
<style>
    .profile-card {
        background: #fff;
        border-radius: 20px;
        padding: 40px;
        box-shadow: var(--dash-shadow);
        border: var(--dash-border);
    }

    .form-section-title {
        font-weight: 800;
        font-size: 1.25rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid rgba(255, 78, 80, 0.1);
        display: inline-block;
    }

    .profile-form .form-label-premium {
        font-weight: 700;
        font-size: 0.85rem;
        text-transform: uppercase;
        color: var(--gray-500);
        margin-bottom: 10px;
    }

    .profile-form .form-control-premium {
        height: 55px;
        border-radius: 12px;
        border: 2px solid var(--gray-200);
        padding: 0 20px;
        font-weight: 600;
        transition: all 0.3s ease;
        background-color: #fcfcfc;
    }

    .profile-form .form-control-premium:focus {
        background-color: #fff;
        border-color: var(--dash-primary);
        box-shadow: 0 0 0 4px rgba(255, 78, 80, 0.05);
    }

    .profile-form .form-control-premium[readonly] {
        background-color: #f8f9fa;
        color: var(--gray-500);
        cursor: not-allowed;
    }

    .update-profile-btn {
        background: var(--theme-black);
        color: white;
        padding: 16px 40px;
        border-radius: 30px;
        font-weight: 800;
        letter-spacing: 1px;
        transition: all 0.3s ease;
        border: none;
        margin-top: 20px;
    }

    .update-profile-btn:hover {
        background: var(--dash-primary);
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(255, 78, 80, 0.2);
    }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="dashboard-header-premium mb-4">
    <h2>Account Details</h2>
    <p>Update your personal information and email address.</p>
</div>

<div class="profile-card animate-fade-in">
    <h4 class="form-section-title">Personal Information</h4>
    
    <form id="profile-form" class="profile-form">
        <div class="row">
            <div class="col-md-12 mb-4">
                <label class="form-label-premium">Username</label>
                <input type="text" class="form-control form-control-premium" id="username" readonly>
                <small class="text-muted">Username cannot be changed.</small>
            </div>
            
            <div class="col-md-12 mb-4">
                <label class="form-label-premium">Email Address</label>
                <input type="email" class="form-control form-control-premium" id="email" placeholder="Enter your email">
            </div>
            
            <div class="col-md-6 mb-4">
                <label class="form-label-premium">First Name</label>
                <input type="text" class="form-control form-control-premium" id="first_name" placeholder="John">
            </div>
            
            <div class="col-md-6 mb-4">
                <label class="form-label-premium">Last Name</label>
                <input type="text" class="form-control form-control-premium" id="last_name" placeholder="Doe">
            </div>
        </div>
        
        <div class="text-end">
            <button type="submit" class="update-profile-btn">
                SAVE CHANGES
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block dash_extra_js %}
<script>
    async function loadProfile() {
        try {
            const data = await apiFetch('/auth/user/');
            document.getElementById('username').value = data.username || '';
            document.getElementById('email').value = data.email || '';
            document.getElementById('first_name').value = data.first_name || '';
            document.getElementById('last_name').value = data.last_name || '';
            
            // Update sidebar too if needed
            if (document.getElementById('sidebar-name')) {
                document.getElementById('sidebar-name').textContent = data.username;
            }
            if (document.getElementById('sidebar-email')) {
                document.getElementById('sidebar-email').textContent = data.email;
            }
        } catch (error) {
            console.error('Failed to load profile:', error);
            showToast('Failed to load profile', 'danger');
        }
    }
    
    document.getElementById('profile-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        const originalText = btn.textContent;
        btn.textContent = 'SAVING...';
        btn.disabled = true;
        
        try {
            await apiFetch('/auth/user/', {
                method: 'PATCH',
                body: JSON.stringify({
                    email: document.getElementById('email').value,
                    first_name: document.getElementById('first_name').value,
                    last_name: document.getElementById('last_name').value
                })
            });
            
            showToast('Profile updated successfully!', 'success');
            loadProfile(); // Refresh
        } catch (error) {
            console.error('Failed to update profile:', error);
            showToast('Failed to update profile', 'danger');
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    });
    
    document.addEventListener('DOMContentLoaded', loadProfile);
</script>
{% endblock %}
