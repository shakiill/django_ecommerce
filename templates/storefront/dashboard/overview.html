{% extends 'storefront/dashboard/dashboard_base.html' %}
{% load static %}

{% block title %}Dashboard Overview - UOMO{% endblock %}

{% block dash_extra_css %}
<style>
    /* Stats Card Styles */
    .premium-stat-card {
        padding: 30px;
        border-radius: 20px;
        border: 1px solid rgba(0,0,0,0.05);
        background: #fff;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        z-index: 1;
    }

    .premium-stat-card::after {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 100px;
        height: 100px;
        background: var(--dash-primary);
        opacity: 0.03;
        border-radius: 0 0 0 100%;
        z-index: -1;
        transition: all 0.3s ease;
    }

    .premium-stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0,0,0,0.05);
        border-color: rgba(255, 78, 80, 0.2);
    }

    .premium-stat-card:hover::after {
        width: 120px;
        height: 120px;
        opacity: 0.06;
    }

    .stat-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--gray-500);
        margin-bottom: 15px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--theme-black);
        line-height: 1;
        margin-bottom: 5px;
    }

    .stat-meta {
        font-size: 0.85rem;
        color: var(--gray-500);
    }

    .stat-icon-bg {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        background: rgba(255, 78, 80, 0.1);
        color: var(--dash-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        margin-bottom: 20px;
    }

    /* Recent Activity / Order List Styling */
    .premium-table-card {
        margin-top: 20px;
    }

    .premium-table-card .card-header {
        background: transparent;
        border: none;
        padding: 0 0 20px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .premium-table-card .card-header h4 {
        margin: 0;
        font-weight: 800;
        font-size: 1.25rem;
    }

    .recent-order-item {
        display: flex;
        align-items: center;
        padding: 20px;
        background: #fdfdfd;
        border-radius: 15px;
        border: 1px solid rgba(0,0,0,0.03);
        margin-bottom: 12px;
        transition: all 0.2s ease;
    }

    .recent-order-item:hover {
        background: #fff;
        border-color: rgba(255, 78, 80, 0.2);
        box-shadow: 0 5px 15px rgba(0,0,0,0.03);
    }

    .order-item-icon {
        width: 45px;
        height: 45px;
        border-radius: 10px;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 20px;
        color: var(--gray-600);
        font-size: 18px;
    }

    .order-item-info {
        flex: 1;
    }

    .order-item-id {
        font-weight: 700;
        color: var(--theme-black);
        margin-bottom: 2px;
        display: block;
    }

    .order-item-date {
        font-size: 0.85rem;
        color: var(--gray-500);
    }

    .order-item-status {
        padding: 6px 14px;
        border-radius: 30px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-badge.pending { background: #fff8e6; color: #ffa000; }
    .status-badge.processing { background: #e3f2fd; color: #1976d2; }
    .status-badge.shipped { background: #f3e5f5; color: #7b1fa2; }
    .status-badge.delivered { background: #e8f5e9; color: #2e7d32; }
    .status-badge.cancelled { background: #ffebee; color: #d32f2f; }

    .order-item-price {
        font-weight: 800;
        font-size: 1.1rem;
        color: var(--dash-primary);
        margin-left: 20px;
        width: 120px;
        text-align: right;
    }

    .view-btn {
        margin-left: 20px;
        padding: 8px 18px;
        font-size: 0.8rem;
        border-radius: 10px;
    }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="dashboard-header-premium mb-5">
    <h2>Hello, {{ user.username }}!</h2>
    <p>From your account dashboard you can view your <a href="{% url 'order_history' %}" class="text-primary fw-bold text-decoration-underline">recent orders</a>, manage your <a href="{% url 'addresses' %}" class="text-primary fw-bold text-decoration-underline">shipping addresses</a>, and <a href="{% url 'profile' %}" class="text-primary fw-bold text-decoration-underline">edit your profile</a>.</p>
</div>

<!-- Quick Stats -->
<div class="row g-4 mb-5">
    <div class="col-md-4">
        <div class="premium-stat-card">
            <div class="stat-icon-bg">
                <i class="fas fa-shopping-bag"></i>
            </div>
            <div class="stat-label">Total Orders</div>
            <div class="stat-value" id="total-orders">0</div>
            <div class="stat-meta">Lifetime purchases</div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="premium-stat-card">
            <div class="stat-icon-bg">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-label">Pending</div>
            <div class="stat-value" id="pending-orders">0</div>
            <div class="stat-meta">Awaiting delivery</div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="premium-stat-card">
            <div class="stat-icon-bg">
                <i class="fas fa-map-marker-alt"></i>
            </div>
            <div class="stat-label">Addresses</div>
            <div class="stat-value" id="total-addresses">0</div>
            <div class="stat-meta">Saved locations</div>
        </div>
    </div>
</div>

<!-- Recent Orders Section -->
<div class="premium-table-card">
    <div class="card-header">
        <h4>Recent Orders</h4>
        <a href="{% url 'order_history' %}" class="btn btn-sm btn-outline-dark px-4" style="font-size: 12px; border-radius: 30px;">View All</a>
    </div>
    
    <div id="recent-orders-container">
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block dash_extra_js %}
<script>
    // Load dashboard stats
    async function loadDashboardStats() {
        try {
            // Load orders
            const ordersData = await apiFetch('/orders/');
            const totalOrders = ordersData.count || (Array.isArray(ordersData) ? ordersData.length : 0);
            
            let pendingOrders = 0;
            if (ordersData.results) {
                 pendingOrders = ordersData.results.filter(o => o.status === 'pending' || o.status === 'processing').length;
            } else if (Array.isArray(ordersData)) {
                 pendingOrders = ordersData.filter(o => o.status === 'pending' || o.status === 'processing').length;
            }
            
            document.getElementById('total-orders').textContent = totalOrders;
            document.getElementById('pending-orders').textContent = pendingOrders;
            
            // Load addresses
            try {
                const addressData = await apiFetch('/addresses/');
                document.getElementById('total-addresses').textContent = addressData.count || (Array.isArray(addressData) ? addressData.length : 0);
            } catch (e) {
                console.warn('Address fetch failed', e);
            }
            
        } catch (error) {
            console.error('Failed to load stats:', error);
        }
    }
    
    // Load recent orders
    async function loadRecentOrders() {
        const container = document.getElementById('recent-orders-container');
        
        try {
            const data = await apiFetch('/orders/?page_size=5');
            const orders = data.results || (Array.isArray(data) ? data : []);
            
            if (orders.length > 0) {
                container.innerHTML = orders.map(order => `
                    <div class="recent-order-item">
                        <div class="order-item-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="order-item-info">
                            <span class="order-item-id">Order #${order.order_number || order.id}</span>
                            <span class="order-item-date">${new Date(order.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                        </div>
                        <div class="order-item-status">
                            <span class="status-badge ${order.status}">${order.status}</span>
                        </div>
                        <div class="order-item-price">à§³${(parseFloat(order.total_amount) || 0).toFixed(2)}</div>
                        <a href="/my-account/orders/${order.id}/" class="btn btn-sm btn-dark view-btn">Details</a>
                    </div>
                `).join('');
            } else {
                container.innerHTML = `
                    <div class="text-center py-5 bg-white rounded-4 border border-dashed">
                        <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                        <h5>No orders yet</h5>
                        <p class="text-muted">Once you start shopping, your orders will appear here.</p>
                        <a href="/shop/" class="btn btn-primary mt-2">Start Shopping</a>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Failed to load orders:', error);
            container.innerHTML = `
                <div class="alert alert-danger rounded-4">
                    <i class="fas fa-exclamation-circle me-2"></i> Failed to load orders. Please try refreshing.
                </div>
            `;
        }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadDashboardStats();
        loadRecentOrders();
    });
</script>
{% endblock %}
