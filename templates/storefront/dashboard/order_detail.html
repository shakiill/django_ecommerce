{% extends 'storefront/dashboard/dashboard_base.html' %}
{% load static %}

{% block title %}Order Details - UOMO{% endblock %}

{% block dash_extra_css %}
<style>
    .order-detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .order-meta-info {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
        margin-bottom: 30px;
    }

    .meta-item {
        display: flex;
        flex-direction: column;
    }

    .meta-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: var(--gray-500);
        font-weight: 700;
        letter-spacing: 0.5px;
        margin-bottom: 5px;
    }

    .meta-value {
        font-weight: 700;
        color: var(--theme-black);
        font-size: 1.1rem;
    }

    .order-items-table {
        width: 100%;
        margin-top: 20px;
    }

    .order-items-table th {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: var(--gray-500);
        font-weight: 700;
        padding: 15px;
        border-bottom: 2px solid #f8f9fa;
    }

    .order-items-table td {
        padding: 20px 15px;
        border-bottom: 1px solid #f8f9fa;
        vertical-align: middle;
    }

    .product-thumb {
        width: 70px;
        height: 70px;
        border-radius: 12px;
        object-fit: cover;
        background: #f8f9fa;
    }

    .product-name-link {
        font-weight: 700;
        color: var(--theme-black);
        text-decoration: none;
        transition: color 0.2s;
    }

    .product-name-link:hover {
        color: var(--dash-primary);
    }

    .order-summary-card {
        background: #f8f9fa;
        border-radius: 20px;
        padding: 30px;
        margin-top: 30px;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        font-weight: 500;
        color: var(--gray-700);
    }

    .summary-row.total {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid rgba(0,0,0,0.05);
        font-size: 1.25rem;
        font-weight: 800;
        color: var(--theme-black);
    }

    .status-badge-premium {
        padding: 10px 20px;
        border-radius: 30px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 0.75rem;
    }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="mb-4">
    <a href="{% url 'order_history' %}" class="btn btn-sm btn-outline-dark px-4 rounded-pill">
        <i class="fas fa-arrow-left me-2"></i> BACK TO ORDERS
    </a>
</div>

<div id="order-detail-container">
    <div class="text-center py-5">
        <div class="spinner-border text-primary"></div>
    </div>
</div>
{% endblock %}

{% block dash_extra_js %}
<script>
    const orderId = {{ order_id }};
    
    async function loadOrderDetail() {
        const container = document.getElementById('order-detail-container');
        
        try {
            const order = await apiFetch(`/orders/${orderId}/`);
            
            let itemsHtml = (order.items || []).map(item => `
                <tr>
                    <td style="width: 100px;">
                        <img src="${item.product_image || '{% static "assets/images/placeholder.jpg" %}'}" class="product-thumb" alt="${item.product_name}">
                    </td>
                    <td>
                        <a href="/products/${item.product_slug}/" class="product-name-link">${item.product_name}</a>
                        ${item.variant_name ? `<div class="small text-muted mt-1">Variant: ${item.variant_name}</div>` : ''}
                    </td>
                    <td class="text-center fw-bold">৳${parseFloat(item.price).toFixed(2)}</td>
                    <td class="text-center fw-bold">x${item.quantity}</td>
                    <td class="text-end fw-800">৳${(parseFloat(item.price) * item.quantity).toFixed(2)}</td>
                </tr>
            `).join('');

            container.innerHTML = `
                <div class="animate-fade-in">
                    <div class="order-detail-header">
                        <div>
                            <h2 class="fw-800">Order #${order.order_number || order.id}</h2>
                            <p class="text-muted mb-0">Placed on ${new Date(order.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                        </div>
                        <div class="status-badge-premium status-badge ${order.status}">
                            ${order.status}
                        </div>
                    </div>

                    <div class="order-meta-info">
                        <div class="meta-item">
                            <span class="meta-label">Payment Method</span>
                            <span class="meta-value">${order.payment_method || 'Standard'}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Payment Status</span>
                            <span class="meta-value">${order.payment_status || 'Pending'}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Total Amount</span>
                            <span class="meta-value text-primary">৳${parseFloat(order.total_amount).toFixed(2)}</span>
                        </div>
                    </div>

                    <div class="dash-card p-0 overflow-hidden">
                        <div class="table-responsive">
                            <table class="order-items-table">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Details</th>
                                        <th class="text-center">Price</th>
                                        <th class="text-center">Qty</th>
                                        <th class="text-end">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsHtml || '<tr><td colspan="5" class="text-center py-4">No items found in this order.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-6">
                            <div class="order-summary-card">
                                <h4 class="fw-800 text-uppercase mb-4" style="font-size: 1rem; letter-spacing: 1px;">Summary</h4>
                                <div class="summary-row">
                                    <span>Subtotal</span>
                                    <span>৳${parseFloat(order.total_amount).toFixed(2)}</span>
                                </div>
                                <div class="summary-row">
                                    <span>Shipping</span>
                                    <span>৳0.00</span>
                                </div>
                                <div class="summary-row total">
                                    <span>TOTAL</span>
                                    <span>৳${parseFloat(order.total_amount).toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                             <div class="order-summary-card h-100">
                                <h4 class="fw-800 text-uppercase mb-4" style="font-size: 1rem; letter-spacing: 1px;">Shipping Address</h4>
                                <p class="mb-1 fw-bold">${order.shipping_address_name || user.username}</p>
                                <p class="mb-0 text-muted">${order.shipping_address || 'Address details not stored with order.'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } catch (error) {
            console.error('Failed to load order details:', error);
            container.innerHTML = `<div class="alert alert-danger rounded-4">Failed to load order details.</div>`;
        }
    }
    
    document.addEventListener('DOMContentLoaded', loadOrderDetail);
</script>
{% endblock %}
