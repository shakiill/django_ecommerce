{% extends 'includes/main_layout.html' %}
{% load static %}
{% block content %}
    <div class="d-flex flex-column flex-column-fluid">
        <div id="kt_app_toolbar" class="app-toolbar py-3 py-lg-6">
            <div id="kt_app_toolbar_container" class="app-container container-xxl d-flex flex-stack">
                <div class="page-title d-flex flex-column justify-content-center flex-wrap me-3">
                    <h1 class="page-heading d-flex text-dark fw-bold fs-3 flex-column justify-content-center my-0">
                        {% if is_edit %}Edit{% else %}Create{% endif %} Requisition
                    </h1>
                </div>
                <div class="d-flex align-items-center gap-2 gap-lg-3">
                    <a href="{% url 'inventory:requisition_list' %}" class="btn btn-sm fw-bold btn-light">Back to
                        list</a>
                </div>
            </div>
        </div>
        <div id="kt_app_content" class="app-content flex-column-fluid">
            <div id="kt_app_content_container" class="app-container container-xxl">
                <form method="post" novalidate>
                    {% csrf_token %}
                    <div class="card mb-6">
                        <div class="card-header">
                            <div class="card-title">Requisition Info</div>
                        </div>
                        <div class="card-body p-6">
                            {% if form.non_field_errors %}
                                <div class="alert alert-danger">{{ form.non_field_errors }}</div>
                            {% endif %}
                            <div class="row g-5">
                                <div class="col-md-4">
                                    {{ form.warehouse.label_tag }}
                                    {{ form.warehouse }}
                                    <div class="form-text">Select warehouse for this requisition.</div>
                                    {{ form.warehouse.errors }}
                                </div>
                                <div class="col-md-4">
                                    {{ form.requisition_date.label_tag }}
                                    <div class="input-group">
                                        {{ form.requisition_date }}
                                        <span class="input-group-text"><i class="bi bi-calendar-date"></i></span>
                                    </div>
                                    <div class="form-text">Date of requisition.</div>
                                    {{ form.requisition_date.errors }}
                                </div>
                                <div class="col-md-4">
                                    {{ form.required_date.label_tag }}
                                    <div class="input-group">
                                        {{ form.required_date }}
                                        <span class="input-group-text"><i class="bi bi-calendar-date"></i></span>
                                    </div>
                                    <div class="form-text">Date items are required.</div>
                                    {{ form.required_date.errors }}
                                </div>
                                <div class="col-md-4">
                                    {{ form.priority.label_tag }}
                                    {{ form.priority }}
                                    <div class="form-text">Set priority level.</div>
                                    {{ form.priority.errors }}
                                </div>
                                <div class="col-md-4">
                                    {{ form.department.label_tag }}
                                    {{ form.department }}
                                    <div class="form-text">Department requesting items.</div>
                                    {{ form.department.errors }}
                                </div>
                                <div class="col-md-12">
                                    {{ form.purpose.label_tag }}
                                    {{ form.purpose }}
                                    <div class="form-text">Describe the purpose of this requisition.</div>
                                    {{ form.purpose.errors }}
                                </div>
                                <div class="col-md-12">
                                    {{ form.notes.label_tag }}
                                    {{ form.notes }}
                                    <div class="form-text">Additional notes (optional).</div>
                                    {{ form.notes.errors }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-6">

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Items</div>
                        </div>
                        <div class="card-body p-6">
                            {% if formset.non_form_errors %}
                                <div class="alert alert-danger">{{ formset.non_form_errors }}</div>
                            {% endif %}
                            {{ formset.management_form }}
                            <div class="mb-3 d-flex gap-2 flex-wrap">
                                <button type="button" class="btn btn-light-primary" id="add-item"
                                        title="Add new item row">
                                    <i class="bi bi-plus-circle"></i> Add Row
                                </button>
                                <button type="button" class="btn btn-light-success" id="bulk-import-btn"
                                        title="Bulk import products">
                                    <i class="bi bi-upload"></i> Bulk Import
                                </button>
                                <button type="button" class="btn btn-light-info" id="search-product-btn"
                                        title="Search and add product">
                                    <i class="bi bi-search"></i> Search Product
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-row-dashed align-middle" id="items-table">
                                    <thead>
                                    <tr>
                                        <th style="width:35%">Product Variant</th>
                                        <th style="width:10%">Qty</th>
                                        <th style="width:15%">Unit Price</th>
                                        <th style="width:30%">Specifications</th>
                                        <th style="width:10%">Actions</th>
                                    </tr>
                                    </thead>
                                    <tbody id="items-body">
                                    {% for f in formset %}
                                        <tr class="item-row align-middle">
                                            <td>{{ f.product_variant }} {{ f.product_variant.errors }}</td>
                                            <td>{{ f.quantity_requested }} {{ f.quantity_requested.errors }}</td>
                                            <td>
                                                <div class="input-group">
                                                    {{ f.estimated_unit_price }}
                                                    <span class="input-group-text"><i class="bi bi-currency-dollar"></i></span>
                                                </div>
                                                {{ f.estimated_unit_price.errors }}
                                            </td>
                                            <td>{{ f.specifications }} {{ f.specifications.errors }}</td>
                                            <td>
                                                {% if is_edit %}
                                                    <label class="form-check form-check-sm form-check-custom form-check-solid"
                                                           title="Mark for deletion">
                                                        {{ f.DELETE }}<span class="ms-2">Delete</span>
                                                    </label>
                                                {% else %}
                                                    <button type="button"
                                                            class="btn btn-sm btn-light-danger btn-remove-row"
                                                            title="Remove row">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                {% endif %}
                                            </td>
                                            {% for hidden in f.hidden_fields %}{{ hidden }}{% endfor %}
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer d-flex justify-content-end">
                            <button class="btn btn-primary px-6 py-2">Save</button>
                        </div>
                    </div>
                </form>

                <!-- Bulk Import Modal -->
                <div class="modal fade" id="bulkImportModal" tabindex="-1" aria-labelledby="bulkImportModalLabel"
                     aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="bulkImportModalLabel">Bulk Import Products</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-4">
                                    <label for="import-brand" class="form-label">Brand</label>
                                    <select id="import-brand" class="form-select">
                                        <option value="">-- Select Brand (Optional) --</option>
                                    </select>
                                </div>
                                <div class="mb-4">
                                    <label for="import-category" class="form-label">Category</label>
                                    <select id="import-category" class="form-select">
                                        <option value="">-- Select Category (Optional) --</option>
                                    </select>
                                </div>
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> Select Brand, Category, or both to filter
                                    products. All
                                    matching product variants will be added.
                                </div>
                                <div id="import-preview" class="d-none">
                                    <div class="text-muted mb-2">Products to import:</div>
                                    <div id="import-count" class="fw-bold text-primary"></div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="import-products-btn">
                                    <span class="indicator-label">Import Products</span>
                                    <span class="indicator-progress d-none">Please wait... <span
                                            class="spinner-border spinner-border-sm align-middle ms-2"></span></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search Product Modal -->
                <div class="modal fade" id="searchProductModal" tabindex="-1" aria-labelledby="searchProductModalLabel"
                     aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="searchProductModalLabel">Search and Add Product</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-4">
                                    <label for="product-search-input" class="form-label">Search Products</label>
                                    <input type="text" id="product-search-input" class="form-control"
                                           placeholder="Type product name, SKU, or barcode...">
                                    <div class="form-text">Search for a product to add all its variants</div>
                                </div>
                                <div id="search-results" class="list-group"
                                     style="max-height: 400px; overflow-y: auto;">
                                    <div class="text-muted text-center py-4">Start typing to search products...</div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
{% endblock %}

{% block title %}{% if is_edit %}Edit{% else %}Create{% endif %} Requisition{% endblock %}

{% block extra_js %}
    <script>
        (function () {
            // Global variables
            let bulkImportModal, searchProductModal, searchTimeout;

            function initProductVariantSelects(context) {
                if (window.jQuery && $.fn.select2) {
                    $(context).find('select').select2({width: '100%'});
                }
            }

            function updateFormCount(delta) {
                const total = document.querySelector('[name$="-TOTAL_FORMS"]');
                total.value = String(parseInt(total.value || '0', 10) + delta);
            }

            // Build a new row using Django formset's empty_form to ensure correct names
            function addVariantToFormset(variant) {
                const total = document.querySelector('[name$="-TOTAL_FORMS"]');
                const idx = parseInt(total.value || '0', 10);

                const emptyFormHtml = `{{ formset.empty_form.as_p|escapejs }}`.replace(/__prefix__/g, idx);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = emptyFormHtml;
                const fields = tempDiv.querySelectorAll('p');

                const tr = document.createElement('tr');
                tr.className = 'item-row align-middle table-active';

                // Product Variant
                const tdVariant = document.createElement('td');
                const variantField = fields[0].querySelector('select') || fields[0].querySelector('input') || fields[0];
                if (variantField.tagName && variantField.tagName.toLowerCase() === 'select') {
                    let opt = Array.from(variantField.options).find(o => o.value === String(variant.id));
                    if (!opt) {
                        opt = document.createElement('option');
                        opt.value = String(variant.id);
                        opt.text = variant.display_name || (`#${variant.id}`);
                        variantField.appendChild(opt);
                    }
                    variantField.value = String(variant.id);
                } else if (variantField.tagName && variantField.tagName.toLowerCase() === 'input') {
                    variantField.value = String(variant.id);
                }
                tdVariant.appendChild(variantField);
                tr.appendChild(tdVariant);

                // Quantity
                const tdQty = document.createElement('td');
                const qtyField = fields[1].querySelector('input') || fields[1];
                if (qtyField.tagName && qtyField.tagName.toLowerCase() === 'input') {
                    qtyField.value = '1';
                }
                tdQty.appendChild(qtyField);
                tr.appendChild(tdQty);

                // Price
                const tdPrice = document.createElement('td');
                const inputGroup = document.createElement('div');
                inputGroup.className = 'input-group';
                const priceField = fields[2].querySelector('input') || fields[2];
                if (priceField.tagName && priceField.tagName.toLowerCase() === 'input') {
                    priceField.value = (variant.price != null ? variant.price : '0.00');
                }
                inputGroup.appendChild(priceField);
                const span = document.createElement('span');
                span.className = 'input-group-text';
                span.innerHTML = '<i class="bi bi-currency-dollar"></i>';
                inputGroup.appendChild(span);
                tdPrice.appendChild(inputGroup);
                tr.appendChild(tdPrice);

                // Specifications
                const tdSpecs = document.createElement('td');
                const specsField = fields[3].querySelector('textarea') || fields[3];
                tdSpecs.appendChild(specsField);
                tr.appendChild(tdSpecs);

                // Actions
                const tdActions = document.createElement('td');
                tdActions.innerHTML = `
                  <button type="button" class="btn btn-sm btn-light-danger btn-remove-row" title="Remove row">
                    <i class="bi bi-trash"></i>
                  </button>`;
                tr.appendChild(tdActions);

                // Hidden/extra fields
                for (let i = 4; i < fields.length; i++) {
                    const hiddenInputs = fields[i].querySelectorAll('input[type="hidden"]');
                    hiddenInputs.forEach(input => tr.appendChild(input));
                }

                document.getElementById('items-body').appendChild(tr);
                updateFormCount(1);
                initProductVariantSelects(tr);
                return tr;
            }

            function loadFilters() {
                // Brands
                fetch('/master/api/brands/')
                    .then(r => {
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        return r.json();
                    })
                    .then(data => {
                        const brandSelect = document.getElementById('import-brand');
                        (data.results || data || []).forEach(brand => {
                            const opt = document.createElement('option');
                            opt.value = brand.id;
                            opt.text = brand.name;
                            brandSelect.appendChild(opt);
                        });
                    })
                    .catch(err => console.error('Error loading brands:', err));

                // Categories
                fetch('/master/api/categories/')
                    .then(r => {
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        return r.json();
                    })
                    .then(data => {
                        const categorySelect = document.getElementById('import-category');
                        (data.results || data || []).forEach(cat => {
                            const opt = document.createElement('option');
                            opt.value = cat.id;
                            opt.text = cat.name;
                            categorySelect.appendChild(opt);
                        });
                    })
                    .catch(err => console.error('Error loading categories:', err));
            }

            function bulkImportProducts() {
                const brandId = document.getElementById('import-brand').value;
                const categoryId = document.getElementById('import-category').value;
                if (!brandId && !categoryId) {
                    alert('Please select at least Brand or Category');
                    return;
                }

                const btn = document.getElementById('import-products-btn');
                const label = btn.querySelector('.indicator-label');
                const progress = btn.querySelector('.indicator-progress');
                label.classList.add('d-none');
                progress.classList.remove('d-none');
                btn.disabled = true;

                const params = new URLSearchParams();
                if (brandId) params.append('brand', brandId);
                if (categoryId) params.append('category', categoryId);

                fetch(`/inventory/api/variants/?${params.toString()}`)
                    .then(r => {
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        return r.json();
                    })
                    .then(data => {
                        if (data.error) {
                            alert(`Error: ${data.error}`);
                            return;
                        }
                        if (!data.variants?.length) {
                            alert('No products found with the selected filters');
                            return;
                        }
                        let addedCount = 0;
                        data.variants.forEach(variant => {
                            const existingSelects = document.querySelectorAll('[name$="-product_variant"]');
                            let exists = false;
                            existingSelects.forEach(select => {
                                if (select.value === String(variant.id)) exists = true;
                            });
                            if (!exists) {
                                addVariantToFormset(variant);
                                addedCount++;
                            }
                        });
                        alert(`Added ${addedCount} product variant(s) (${data.variants.length - addedCount} already in list)`);
                        bulkImportModal.hide();
                        document.getElementById('import-brand').value = '';
                        document.getElementById('import-category').value = '';
                    })
                    .catch(err => {
                        console.error('Import error:', err);
                        alert(`Error loading products: ${err.message}`);
                    })
                    .finally(() => {
                        label.classList.remove('d-none');
                        progress.classList.add('d-none');
                        btn.disabled = false;
                    });
            }

            // Search products
            function searchProducts(query) {
                if (!query || query.length < 2) {
                    document.getElementById('search-results').innerHTML = '<div class="text-muted text-center py-4">Start typing to search products...</div>';
                    return;
                }
                document.getElementById('search-results').innerHTML = '<div class="text-muted text-center py-4"><span class="spinner-border spinner-border-sm"></span> Searching...</div>';

                fetch(`/inventory/api/products/search/?q=${encodeURIComponent(query)}`)
                    .then(r => {
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        return r.json();
                    })
                    .then(data => {
                        const resultsDiv = document.getElementById('search-results');
                        if (data.error) {
                            resultsDiv.innerHTML = `<div class=\"text-danger text-center py-4\">Error: ${data.error}</div>`;
                            return;
                        }
                        if (!data.products?.length) {
                            resultsDiv.innerHTML = '<div class="text-muted text-center py-4">No products found</div>';
                            return;
                        }
                        resultsDiv.innerHTML = '';
                        data.products.forEach(product => {
                            const item = document.createElement('a');
                            item.href = '#';
                            item.className = 'list-group-item list-group-item-action';
                            item.innerHTML = `
                                <div class="d-flex w-100 justify-content-between">
                                  <h6 class="mb-1">${product.name}</h6>
                                  <small class="text-muted">${product.variant_count} variant(s)</small>
                                </div>
                                <p class="mb-1 text-muted small">${product.brand || ''} ${product.category ? 'â€¢ ' + product.category : ''}</p>`;
                            item.onclick = (e) => {
                                e.preventDefault();
                                addProductVariants(product.id);
                            };
                            resultsDiv.appendChild(item);
                        });
                    })
                    .catch(err => {
                        console.error('Search error:', err);
                        document.getElementById('search-results').innerHTML = `<div class=\"text-danger text-center py-4\">Error: ${err.message}</div>`;
                    });
            }

            function addProductVariants(productId) {
                fetch(`/inventory/api/products/${productId}/variants/`)
                    .then(r => {
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        return r.json();
                    })
                    .then(data => {
                        if (data.error) {
                            alert(`Error: ${data.error}`);
                            return;
                        }
                        if (!data.variants?.length) {
                            alert('No variants found for this product');
                            return;
                        }
                        let addedCount = 0;
                        data.variants.forEach(variant => {
                            const existingSelects = document.querySelectorAll('[name$="-product_variant"]');
                            let exists = false;
                            existingSelects.forEach(select => {
                                if (select.value === String(variant.id)) exists = true;
                            });
                            if (!exists) {
                                addVariantToFormset(variant);
                                addedCount++;
                            }
                        });
                        alert(`Added ${addedCount} variant(s) (${data.variants.length - addedCount} already in list)`);
                        searchProductModal.hide();
                    })
                    .catch(err => {
                        console.error('Product variants error:', err);
                        alert(`Error loading product variants: ${err.message}`);
                    });
            }

            // Add Row button (manual add)
            document.getElementById('add-item').addEventListener('click', function () {
                const total = document.querySelector('[name$="-TOTAL_FORMS"]');
                const idx = parseInt(total.value || '0', 10);
                const emptyFormHtml = `{{ formset.empty_form.as_p|escapejs }}`.replace(/__prefix__/g, idx);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = emptyFormHtml;
                const fields = tempDiv.querySelectorAll('p');

                const tr = document.createElement('tr');
                tr.className = 'item-row align-middle table-active';

                const tdVariant = document.createElement('td');
                tdVariant.appendChild(fields[0].querySelector('select') || fields[0].querySelector('input') || fields[0]);
                tr.appendChild(tdVariant);

                const tdQty = document.createElement('td');
                tdQty.appendChild(fields[1].querySelector('input') || fields[1]);
                tr.appendChild(tdQty);

                const tdPrice = document.createElement('td');
                const inputGroup = document.createElement('div');
                inputGroup.className = 'input-group';
                inputGroup.appendChild(fields[2].querySelector('input') || fields[2]);
                const span = document.createElement('span');
                span.className = 'input-group-text';
                span.innerHTML = '<i class="bi bi-currency-dollar"></i>';
                inputGroup.appendChild(span);
                tdPrice.appendChild(inputGroup);
                tr.appendChild(tdPrice);

                const tdSpecs = document.createElement('td');
                tdSpecs.appendChild(fields[3].querySelector('textarea') || fields[3]);
                tr.appendChild(tdSpecs);

                const tdActions = document.createElement('td');
                tdActions.innerHTML = `
                  <button type="button" class="btn btn-sm btn-light-danger btn-remove-row" title="Remove row">
                    <i class="bi bi-trash"></i>
                  </button>`;
                tr.appendChild(tdActions);

                for (let i = 4; i < fields.length; i++) {
                    const hiddenInputs = fields[i].querySelectorAll('input[type="hidden"]');
                    hiddenInputs.forEach(input => tr.appendChild(input));
                }

                document.getElementById('items-body').appendChild(tr);
                updateFormCount(1);
                initProductVariantSelects(tr);
            });

            // Remove row
            document.getElementById('items-body').addEventListener('click', function (e) {
                if (e.target && e.target.closest('.btn-remove-row')) {
                    const row = e.target.closest('tr');
                    row.parentNode.removeChild(row);
                    updateFormCount(-1);
                }
            });

            // DOM Ready
            document.addEventListener('DOMContentLoaded', function () {
                initProductVariantSelects(document.getElementById('items-body'));
                bulkImportModal = new bootstrap.Modal(document.getElementById('bulkImportModal'));
                searchProductModal = new bootstrap.Modal(document.getElementById('searchProductModal'));
                loadFilters();
                document.getElementById('bulk-import-btn').addEventListener('click', () => bulkImportModal.show());
                document.getElementById('search-product-btn').addEventListener('click', () => searchProductModal.show());
                document.getElementById('import-products-btn').addEventListener('click', bulkImportProducts);
                document.getElementById('product-search-input').addEventListener('input', function (e) {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => searchProducts(e.target.value), 300);
                });
                document.getElementById('searchProductModal').addEventListener('hidden.bs.modal', function () {
                    document.getElementById('product-search-input').value = '';
                    document.getElementById('search-results').innerHTML = '<div class="text-muted text-center py-4">Start typing to search products...</div>';
                });
            });
        })();
    </script>
{% endblock %}
