{% extends 'includes/main_layout.html' %}
{% load static %}
{% block content %}
    <div class="d-flex flex-column flex-column-fluid">
        <div id="kt_app_toolbar" class="app-toolbar py-3 py-lg-6">
            <div id="kt_app_toolbar_container" class="app-container container-xxl d-flex flex-stack">
                <div class="page-title d-flex flex-column justify-content-center flex-wrap me-3">
                    <h1 class="page-heading d-flex text-dark fw-bold fs-3 flex-column justify-content-center my-0">
                        Purchase Requisitions</h1>
                    <ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0 pt-1">
                        <li class="breadcrumb-item text-muted"><a href="/"
                                                                  class="text-muted text-hover-primary">Home</a></li>
                        <li class="breadcrumb-item"><span class="bullet bg-gray-400 w-5px h-2px"></span></li>
                        <li class="breadcrumb-item text-muted">Inventory</li>
                    </ul>
                </div>
                <div class="d-flex align-items-center gap-2 gap-lg-3">
                    <a href="{% url 'inventory:requisition_create' %}" class="btn btn-sm fw-bold btn-primary">Create</a>
                </div>
            </div>
        </div>
        <div id="kt_app_content" class="app-content flex-column-fluid">
            <div id="kt_app_content_container" class="app-container container-xxl">

                <div class="card mb-5">
                    <div class="card-body pt-4">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-2">
                                <label class="form-label">PR #</label>
                                <input type="text" id="filter_pr" class="form-control" placeholder="PR number"/>
            </div>
                            <div class="col-md-2">
                                <label class="form-label">Status</label>
                                <select id="filter_status" class="form-select">
                                    <option value="">All</option>
                                    {% for key, label in requisition_statuses %}
                                        <option value="{{ key }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Warehouse</label>
                                <select id="filter_warehouse" class="form-select">
                                    <option value="">All</option>
                                    {% for w in warehouses %}
                                        <option value="{{ w.id }}">{{ w.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">From</label>
                                <input type="date" id="filter_from" class="form-control"/>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">To</label>
                                <input type="date" id="filter_to" class="form-control"/>
                            </div>
                            <div class="col-md-2">
                                <button id="btn_filter" class="btn btn-primary w-100">Filter</button>
                            </div>
                        </div>
        </div>
                </div>

                <div class="card">
                    <div class="card-body pt-0">
                        <div class="alert alert-danger d-none" id="dt-error"></div>
                        <table id="requisitionTable" class="table table-striped table-row-bordered gy-5 gs-7 w-100">
                            <thead>
                            <tr>
                                <th>PR #</th>
                                <th>Warehouse</th>
                                <th>Req Date</th>
                                <th>Required</th>
                                <th>Status</th>
                                <th>Priority</th>
                                <th>Requested By</th>
                                <th>Total</th>
                                <th>Action</th>
                            </tr>
                            </thead>
                        </table>
                        <form id="delete-form" method="post" class="d-none">
                            {% csrf_token %}
                        </form>
                    </div>
                </div>

            </div>
        </div>
    </div>
{% endblock %}

{% block title %}Purchase Requisitions{% endblock %}

{% block extra_js %}
    <script>
        (function ($) {
            const $error = $('#dt-error');
            const table = $('#requisitionTable').DataTable({
                ajax: {
                    url: '{% url "inventory:requisition_list_data" %}',
                    data: function (d) {
                        d.status = document.getElementById('filter_status').value;
                        d.warehouse = document.getElementById('filter_warehouse').value;
                        d.pr_number = document.getElementById('filter_pr').value;
                        d.date_from = document.getElementById('filter_from').value;
                        d.date_to = document.getElementById('filter_to').value;
                    },
                    error: function (xhr) {
                        let msg = 'Ajax error (' + xhr.status + '): ' + (xhr.responseText || '').slice(0, 300);
                        $error.text(msg).removeClass('d-none');
                    }
                },
                processing: true,
                serverSide: false,
                searching: false,
                lengthChange: true,
                pageLength: 25,
                columns: [
                    {data: 'pr_number'},
                    {data: 'warehouse'},
                    {data: 'requisition_date'},
                    {data: 'required_date'},
                    {data: 'status'},
                    {data: 'priority'},
                    {data: 'requested_by'},
                    {data: 'total_amount'},
                    {
                        data: null, orderable: false, render: function (data, type, row) {
                            return `
              <a href="${row.detail_url}" class="btn btn-sm btn-light-info">View</a>
              <a href="${row.edit_url}" class="btn btn-sm btn-light-warning">Edit</a>
              <button type="button" data-url="${row.delete_url}" class="btn btn-sm btn-light-danger btn-delete">Delete</button>
            `;
                        }
                    }
                ]
            });

            document.getElementById('btn_filter').addEventListener('click', function () {
                $error.addClass('d-none').empty();
                table.ajax.reload();
            });

            $(document).on('click', '.btn-delete', function () {
                if (!confirm('Delete this requisition?')) return;
                const url = this.getAttribute('data-url');
                const form = document.getElementById('delete-form');
                form.action = url;
                form.submit();
            });
        })(jQuery);
    </script>
{% endblock %}
